<!doctype html>
<html lang="id">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Router Checklist ‚Äî Corporate Blue (Pro)</title>
<style>
  :root{
    --bg:#f3f6fb;
    --card:#ffffff;
    --accent:#0a66c2; /* corporate blue */
    --muted:#6b7280;
    --radius:12px;
    --pad:18px;
    --shadow: 0 8px 30px rgba(10,102,194,0.08);
    --mono: "Inter", "Poppins", system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial;
  }
  *{box-sizing:border-box}
  body{
    margin:0;
    font-family:var(--mono);
    background:var(--bg);
    color:#12202b;
    -webkit-font-smoothing:antialiased;
    -moz-osx-font-smoothing:grayscale;
    padding:28px;
  }
  .wrap{
    max-width:1100px;
    margin:0 auto;
  }
  .card{
    background:var(--card);
    border-radius:var(--radius);
    box-shadow:var(--shadow);
    padding: var(--pad);
    overflow:hidden;
  }

  /* header */
  .top{
    display:flex;
    align-items:center;
    gap:18px;
    margin-bottom:14px;
  }
  .logo{
    width:74px;height:74px;border-radius:10px;
    display:flex;align-items:center;justify-content:center;
    background:linear-gradient(135deg,var(--accent),#2b87ff);
    color:white;font-weight:700;font-size:20px;
    box-shadow:0 4px 18px rgba(10,102,194,0.18);
  }
  .title h2{margin:0;font-size:20px;letter-spacing:0.6px}
  .title p{margin:2px 0 0;color:var(--muted);font-size:13px}

  /* form grid */
  .meta{
    display:grid;grid-template-columns:1fr 1fr 1fr 1fr;gap:12px;margin:18px 0;
  }
  label{font-size:13px;color:var(--muted);display:block}
  input[type="text"], input[type="date"]{
    width:100%;padding:8px 10px;border-radius:8px;border:1px solid #e6e9ef;font-size:14px;
    background:white;
  }

  /* controls */
  .controls{display:flex;gap:10px;flex-wrap:wrap;margin-bottom:12px}
  .btn{
    display:inline-flex;align-items:center;gap:8px;
    padding:8px 12px;border-radius:9px;border:none;background:var(--accent);
    color:white;font-weight:600;cursor:pointer;font-size:13px;
    box-shadow:0 6px 18px rgba(10,102,194,0.12);
  }
  .btn.ghost{background:#fff;color:var(--accent);border:1px solid #dbe9ff;box-shadow:none}
  .small{padding:6px 9px;font-size:12px;border-radius:8px}

  /* checklist table */
  .table-wrap{overflow:auto;border-radius:10px;border:1px solid #eef2f7}
  table{width:100%;border-collapse:collapse;font-size:14px}
  th,td{padding:12px 10px;border-bottom:1px solid #f1f4f8;vertical-align:top}
  thead th{background:linear-gradient(90deg,var(--accent),#2b87ff);color:white;font-weight:700;text-align:left;padding:14px}
  td.status{width:90px;text-align:center}
  textarea{width:100%;min-height:56px;border-radius:8px;padding:8px;border:1px solid #e6e9ef;resize:vertical;font-size:13px}

  /* summary */
  .summary{display:flex;gap:12px;margin-top:12px;flex-wrap:wrap}
  .tile{background:#fff;padding:12px;border-radius:10px;flex:1;min-width:160px;border:1px solid #eef2f7}
  .tile h3{margin:0;font-size:18px;color:var(--accent)}
  .tile p{margin:6px 0 0;color:var(--muted);font-size:13px}

  /* signature area */
  .sigs{display:flex;gap:18px;margin-top:18px}
  .sig-card{flex:1;background:#fafcff;border:1px dashed #e6f0ff;padding:10px;border-radius:10px;text-align:center}
  .sig-card canvas{background:white;border-radius:8px;border:1px solid #e9eef8;display:block;margin:8px auto;touch-action: none}
  .sig-card button{margin:6px 6px 0 0}

  /* footer */
  .footer{display:flex;justify-content:space-between;align-items:center;gap:10px;margin-top:18px;color:var(--muted);font-size:13px}

  /* small helpers */
  .muted{color:var(--muted);font-size:13px}
  .danger{color:#c0392b;font-weight:700}
  .ok-badge{background:#e6f4ff;color:var(--accent);padding:6px 10px;border-radius:20px;font-weight:700}

  /* responsive */
  @media (max-width:900px){
    .meta{grid-template-columns:1fr 1fr}
    .sigs{flex-direction:column}
  }

  /* print adjustments */
  @media print{
    body{padding:0;background:white}
    .wrap{max-width:100%;padding:0}
    .btn, .small{display:none}
    .card{box-shadow:none;border-radius:0;padding:10px}
  }
</style>
</head>
<body>
<div class="wrap">
  <div class="card" id="cardRoot">
    <div class="top">
      <div class="logo" aria-hidden="true">ZN</div>
      <div class="title">
        <h2>Router Inspection Report</h2>
        <p>Audit checklist ‚Äî single router & ports (Corporate)</p>
      </div>
      <div style="margin-left:auto;text-align:right">
        <div class="muted">Generated:</div>
        <div id="genTime" class="muted"></div>
      </div>
    </div>

    <div class="meta" role="form" aria-label="Meta fields">
      <div>
        <label>Nama Router</label>
        <input id="nama" type="text" placeholder="Ex: RTR-JKT-01">
      </div>
      <div>
        <label>Lokasi</label>
        <input id="lokasi" type="text" placeholder="Ex: Rack 3 - Data Center">
      </div>
      <div>
        <label>Tanggal Cek</label>
        <input id="tanggal" type="date">
      </div>
      <div>
        <label>PIC Checker</label>
        <input id="pic" type="text" placeholder="Nama checker">
      </div>
    </div>

    <div class="controls">
      <button class="btn" id="addPortBtn">+ Tambah Port</button>
      <button class="btn ghost small" id="markAllOk">Mark All Normal</button>
      <button class="btn ghost small" id="markAllErr">Mark All Error</button>
      <button class="btn ghost small" id="clearSig">Clear Signatures</button>
      <button class="btn" id="saveBtn">üíæ Simpan Lokal</button>
      <button class="btn" id="downloadJson">‚¨áÔ∏è Unduh JSON</button>
      <button class="btn" id="generatePdf">üìÑ Export PDF</button>
      <select id="historySelect" style="margin-left:auto;padding:8px;border-radius:8px;border:1px solid #e6e9ef">
        <option value="">‚Äî Restore dari history ‚Äî</option>
      </select>
    </div>

    <div class="table-wrap" id="tableWrap">
      <table id="checkTbl" aria-label="Checklist table">
        <thead>
          <tr>
            <th style="width:40%">Item Pengecekan</th>
            <th style="width:10%">Normal</th>
            <th style="width:10%">Error</th>
            <th style="width:40%">Catatan / Remark</th>
          </tr>
        </thead>
        <tbody id="tbody"></tbody>
      </table>
    </div>

    <div class="summary" aria-hidden="true">
      <div class="tile">
        <h3 id="countOk">0</h3>
        <p>Items Normal</p>
      </div>
      <div class="tile">
        <h3 id="countErr">0</h3>
        <p>Items Error</p>
      </div>
      <div class="tile">
        <h3 id="problemList" style="font-size:14px;color:#0b1f3a">‚Äî</h3>
        <p>Daftar item bermasalah</p>
      </div>
    </div>

    <div style="margin-top:12px">
      <div class="muted">Signature / Tanda Tangan</div>
      <div class="sigs">
        <div class="sig-card">
          <div style="font-weight:700">Checker</div>
          <canvas id="sigChecker" width="320" height="110"></canvas>
          <div>
            <button class="btn ghost small" data-action="clear" data-target="checker">Clear</button>
            <button class="btn ghost small" data-action="save" data-target="checker">Save</button>
          </div>
          <div class="muted" style="margin-top:6px">Nama: <input id="sigNameChecker" type="text" placeholder="Nama checker" style="border:none;border-bottom:1px solid #e6eef8;padding:4px"></div>
        </div>

        <div class="sig-card">
          <div style="font-weight:700">Supervisor</div>
          <canvas id="sigSupervisor" width="320" height="110"></canvas>
          <div>
            <button class="btn ghost small" data-action="clear" data-target="supervisor">Clear</button>
            <button class="btn ghost small" data-action="save" data-target="supervisor">Save</button>
          </div>
          <div class="muted" style="margin-top:6px">Nama: <input id="sigNameSupervisor" type="text" placeholder="Nama supervisor" style="border:none;border-bottom:1px solid #e6eef8;padding:4px"></div>
        </div>
      </div>
    </div>

    <div class="footer">
      <div class="muted">Template v1 ‚Äî Corporate Blue ¬∑ Router Audit</div>
      <div class="muted">Local DB: <span id="dbCount">0</span> entries</div>
    </div>
  </div>
</div>

<!-- libs -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

<script>
/* ---------------------------
   Data & default items
   ---------------------------*/
const DEFAULT_ITEMS = [
  "Power & LED indikator",
  "Sinyal & koneksi internet",
  "Akses ke router (via IP)",
  "WiFi SSID muncul",
  "Kecepatan jaringan",
  "Suhu perangkat",
  "Konfigurasi sesuai standar",
  "Firmware up-to-date",
  "Kondisi fisik & kabel",
  "WAN berfungsi"
];

const STORAGE_KEY = 'router_checklist_v2_db';
const HISTORY_KEY = 'router_checklist_v2_history';

const tbody = document.getElementById('tbody');
const genTime = document.getElementById('genTime');
const dbCountEl = document.getElementById('dbCount');
const historySelect = document.getElementById('historySelect');

let itemsState = []; // {id,label,normal,error,remark,isPort}
let signatures = { checker: null, supervisor: null }; // dataURL

/* ---------------------------
   Helpers
   ---------------------------*/
function uid(){return 'id-'+Math.random().toString(36).slice(2,9);}
function nowISO(){return new Date().toISOString();}
function updateGenTime(){genTime.textContent = new Date().toLocaleString();}

/* ---------------------------
   Init items (including ports)
   ---------------------------*/
function initItems(){
  itemsState = DEFAULT_ITEMS.map(l => ({ id:uid(), label:l, normal:false, error:false, remark:'', isPort:false }));
  // default ports 1..4
  for(let i=1;i<=4;i++){
    itemsState.push({ id:uid(), label:`Port LAN ${i} berfungsi`, normal:false, error:false, remark:'', isPort:true });
  }
  renderTable();
  calcSummary();
}

/* ---------------------------
   Render table
   ---------------------------*/
function renderTable(){
  tbody.innerHTML = '';
  itemsState.forEach(it => {
    const tr = document.createElement('tr');
    tr.dataset.id = it.id;

    const tdLabel = document.createElement('td');
    tdLabel.innerHTML = `<div style="display:flex;justify-content:space-between;align-items:center">
      <div style="font-weight:600">${escapeHtml(it.label)}</div>
      ${it.isPort?'<button class="small btn ghost" data-action="remove-port" title="Hapus port">Hapus</button>':''}
    </div>`;
    const tdOk = document.createElement('td'); tdOk.className='status';
    const tdErr = document.createElement('td'); tdErr.className='status';
    const tdRem = document.createElement('td');

    const ok = document.createElement('input'); ok.type='checkbox'; ok.className='ok';
    ok.checked = !!it.normal;
    const err = document.createElement('input'); err.type='checkbox'; err.className='err';
    err.checked = !!it.error;
    const ta = document.createElement('textarea'); ta.value = it.remark || '';

    tdOk.appendChild(ok); tdErr.appendChild(err); tdRem.appendChild(ta);
    tr.appendChild(tdLabel); tr.appendChild(tdOk); tr.appendChild(tdErr); tr.appendChild(tdRem);
    tbody.appendChild(tr);

    // events: mutual exclusive
    ok.addEventListener('change', ()=> {
      if(ok.checked) { err.checked=false; it.normal=true; it.error=false; }
      else it.normal=false;
      it.remark = ta.value;
      saveDraft();
      calcSummary();
    });
    err.addEventListener('change', ()=> {
      if(err.checked) { ok.checked=false; it.error=true; it.normal=false; }
      else it.error=false;
      it.remark = ta.value;
      saveDraft();
      calcSummary();
    });
    ta.addEventListener('input', ()=> { it.remark = ta.value; saveDraft(); });

    // remove port
    tr.querySelector('[data-action="remove-port"]')?.addEventListener('click', ()=>{
      if(confirm('Hapus port ini?')) {
        itemsState = itemsState.filter(x=>x.id!==it.id);
        renderTable(); saveDraft(); calcSummary();
      }
    });
  });
}

/* ---------------------------
   Summary
   ---------------------------*/
function calcSummary(){
  const ok = itemsState.filter(i=>i.normal).length;
  const err = itemsState.filter(i=>i.error).length;
  document.getElementById('countOk').textContent = ok;
  document.getElementById('countErr').textContent = err;
  const problems = itemsState.filter(i=>i.error).map(i=>i.label);
  document.getElementById('problemList').textContent = problems.length ? problems.join(' ¬∑ ') : '‚Äî';
}

/* ---------------------------
   Add port
   ---------------------------*/
document.getElementById('addPortBtn').addEventListener('click', ()=>{
  const numPorts = itemsState.filter(i=>i.isPort).length;
  const label = `Port LAN ${numPorts+1} berfungsi`;
  itemsState.push({ id:uid(), label, normal:false, error:false, remark:'', isPort:true });
  renderTable(); saveDraft(); calcSummary();
});

/* ---------------------------
   Mark all helpers
   ---------------------------*/
document.getElementById('markAllOk').addEventListener('click', ()=> {
  itemsState.forEach(i=>{i.normal=true;i.error=false;});
  renderTable(); saveDraft(); calcSummary();
});
document.getElementById('markAllErr').addEventListener('click', ()=> {
  itemsState.forEach(i=>{i.error=true;i.normal=false;});
  renderTable(); saveDraft(); calcSummary();
});

/* ---------------------------
   Save/Load local DB (history)
   ---------------------------*/
function saveToLocalDB(){
  const db = JSON.parse(localStorage.getItem(STORAGE_KEY) || '[]');
  const payload = buildPayload();
  db.push(payload);
  localStorage.setItem(STORAGE_KEY, JSON.stringify(db));
  updateDBCount();
  populateHistory();
  alert('‚úÖ Data disimpan ke local storage (history).');
}
document.getElementById('saveBtn').addEventListener('click', saveToLocalDB);

function updateDBCount(){
  const db = JSON.parse(localStorage.getItem(STORAGE_KEY) || '[]');
  dbCountEl.textContent = db.length;
}

function populateHistory(){
  const db = JSON.parse(localStorage.getItem(STORAGE_KEY) || '[]');
  historySelect.innerHTML = '<option value="">‚Äî Restore dari history ‚Äî</option>';
  db.slice().reverse().forEach((item, idx) => {
    const opt = document.createElement('option');
    opt.value = item._id;
    opt.textContent = `${new Date(item._saved).toLocaleString()} ¬∑ ${item.meta.nama || 'Unnamed'}`;
    historySelect.appendChild(opt);
  });
}
historySelect.addEventListener('change', ()=>{
  const id = historySelect.value;
  if(!id) return;
  const db = JSON.parse(localStorage.getItem(STORAGE_KEY) || '[]');
  const found = db.find(x=>x._id===id);
  if(found){
    restoreFromPayload(found);
    alert('‚úÖ Restored from history.');
  } else alert('Data not found.');
});

/* ---------------------------
   Quick draft autosave (not history)
   ---------------------------*/
function saveDraft(){
  const draft = buildPayload();
  localStorage.setItem(HISTORY_KEY, JSON.stringify(draft));
}
function loadDraft(){
  const raw = localStorage.getItem(HISTORY_KEY);
  if(!raw) return;
  const d = JSON.parse(raw);
  restoreFromPayload(d, true);
}

/* ---------------------------
   Build payload
   ---------------------------*/
function buildPayload(){
  const meta = {
    nama: document.getElementById('nama').value,
    lokasi: document.getElementById('lokasi').value,
    tanggal: document.getElementById('tanggal').value,
    pic: document.getElementById('pic').value
  };
  const payload = {
    _id: 'rpt-'+Date.now(),
    _saved: nowISO(),
    meta,
    items: itemsState.map(i=>({ label:i.label, normal:!!i.normal, error:!!i.error, remark:i.remark, isPort:!!i.isPort })),
    signatures,
  };
  return payload;
}

function restoreFromPayload(payload, isDraft=false){
  if(!payload) return;
  document.getElementById('nama').value = payload.meta?.nama || '';
  document.getElementById('lokasi').value = payload.meta?.lokasi || '';
  document.getElementById('tanggal').value = payload.meta?.tanggal || '';
  document.getElementById('pic').value = payload.meta?.pic || '';
  itemsState = (payload.items || []).map(x=>({ id:uid(), label:x.label, normal:!!x.normal, error:!!x.error, remark:x.remark||'', isPort:!!x.isPort }));
  signatures = payload.signatures || { checker:null, supervisor:null };
  renderTable(); calcSummary(); renderSigs();
  if(!isDraft) saveDraft();
}

/* ---------------------------
   Download JSON
   ---------------------------*/
document.getElementById('downloadJson').addEventListener('click', ()=>{
  const data = buildPayload();
  const blob = new Blob([JSON.stringify(data, null, 2)], { type:'application/json' });
  const a = document.createElement('a');
  a.href = URL.createObjectURL(blob);
  a.download = `RouterChecklist_${(data.meta.nama||'unnamed')}.json`;
  a.click();
});

/* ---------------------------
   Signatures (simple canvas)
   ---------------------------*/
function setupSig(canvasId, key){
  const canvas = document.getElementById(canvasId);
  const ctx = canvas.getContext('2d');
  ctx.lineWidth = 2;
  ctx.lineCap = 'round';
  let drawing = false;
  let last = null;

  function pos(e){
    const rect = canvas.getBoundingClientRect();
    if(e.touches){
      const t = e.touches[0];
      return { x: t.clientX-rect.left, y: t.clientY-rect.top };
    } else return { x: e.clientX-rect.left, y: e.clientY-rect.top };
  }
  canvas.addEventListener('pointerdown', e => { drawing=true; last=pos(e); });
  canvas.addEventListener('pointermove', e => {
    if(!drawing) return;
    const p = pos(e);
    ctx.beginPath();
    ctx.moveTo(last.x,last.y);
    ctx.lineTo(p.x,p.y);
    ctx.strokeStyle = '#0a66c2';
    ctx.stroke();
    last = p;
  });
  canvas.addEventListener('pointerup', ()=>{ drawing=false; last=null; saveSig(); });
  canvas.addEventListener('pointerleave', ()=>{ drawing=false; last=null; });

  function saveSig(){
    const url = canvas.toDataURL('image/png');
    signatures[key] = url;
    saveDraft();
  }
  function clearSig(){
    ctx.clearRect(0,0,canvas.width,canvas.height);
    signatures[key] = null;
    saveDraft();
  }
  function loadSig(){
    if(signatures[key]){
      const img = new Image();
      img.onload = ()=> ctx.drawImage(img,0,0,canvas.width,canvas.height);
      img.src = signatures[key];
    } else clearSig();
  }
  return {clearSig, saveSig, loadSig, canvas};
}

const sigChecker = setupSig('sigChecker','checker');
const sigSupervisor = setupSig('sigSupervisor','supervisor');

document.querySelectorAll('[data-action="clear"]').forEach(btn=>{
  btn.addEventListener('click', ()=>{
    const t = btn.dataset.target;
    if(t==='checker') sigChecker.clearSig();
    if(t==='supervisor') sigSupervisor.clearSig();
    renderSigs();
  });
});
document.querySelectorAll('[data-action="save"]').forEach(btn=>{
  btn.addEventListener('click', ()=>{
    const t = btn.dataset.target;
    if(t==='checker') sigChecker.saveSig();
    if(t==='supervisor') sigSupervisor.saveSig();
    alert('‚úÖ Signature saved to draft.');
  });
});

function renderSigs(){
  // redraw canvases from signatures var
  sigChecker.loadSig();
  sigSupervisor.loadSig();
  // populate names
  document.getElementById('sigNameChecker').value = signatures.checkerName || '';
  document.getElementById('sigNameSupervisor').value = signatures.supervisorName || '';
}

document.getElementById('sigNameChecker').addEventListener('input',(e)=>{
  signatures.checkerName = e.target.value; saveDraft();
});
document.getElementById('sigNameSupervisor').addEventListener('input',(e)=>{
  signatures.supervisorName = e.target.value; saveDraft();
});
document.getElementById('clearSig').addEventListener('click', ()=>{
  sigChecker.clearSig(); sigSupervisor.clearSig(); renderSigs();
});

/* ---------------------------
   PDF generation (html2canvas + jsPDF)
   - creates multi-page PDF if needed
   ---------------------------*/
document.getElementById('generatePdf').addEventListener('click', async ()=>{
  // validation: at least meta filled
  if(!document.getElementById('nama').value){
    if(!confirm('Nama router kosong. Lanjutkan export PDF?')) return;
  }

  // temporarily mark timestamp
  const timestamp = new Date().toLocaleString();
  const headerFooter = {
    title: 'Router Inspection Report',
    company: 'PT. Zeppelin Networks',
    date: timestamp
  };

  // create a clone of cardRoot to render PDF-friendly (remove controls)
  const node = document.getElementById('cardRoot').cloneNode(true);

  // remove interactive controls/buttons in clone
  node.querySelectorAll('.controls, .btn, button, select, input[type="checkbox"]').forEach(n => n.remove?.());
  // convert inputs and textareas into text nodes in clone
  node.querySelectorAll('input[type="text"], input[type="date"]').forEach(el=>{
    const val = el.value || '-';
    const p = document.createElement('div'); p.style.fontWeight='600'; p.textContent = val;
    el.parentNode.replaceChild(p, el);
  });
  node.querySelectorAll('textarea').forEach(el=>{
    const p = document.createElement('div'); p.style.whiteSpace='pre-wrap'; p.style.minHeight='20px';
    p.textContent = el.value || '-';
    el.parentNode.replaceChild(p, el);
  });

  // render signatures images
  const chkCan = node.querySelector('#sigChecker');
  const supCan = node.querySelector('#sigSupervisor');
  try {
    if(chkCan && signatures.checker){
      const img = document.createElement('img'); img.src = signatures.checker; img.style.maxWidth='220px';
      chkCan.parentNode.replaceChild(img, chkCan);
      const nameNode = node.querySelector('#sigNameChecker');
      if(nameNode){ const nm = document.createElement('div'); nm.textContent = signatures.checkerName||''; nameNode.parentNode.replaceChild(nm,nameNode); }
    }
    if(supCan && signatures.supervisor){
      const img2 = document.createElement('img'); img2.src = signatures.supervisor; img2.style.maxWidth='220px';
      supCan.parentNode.replaceChild(img2, supCan);
      const n2 = node.querySelector('#sigNameSupervisor');
      if(n2){ const nm2 = document.createElement('div'); nm2.textContent = signatures.supervisorName||''; n2.parentNode.replaceChild(nm2,n2); }
    }
  } catch(e){
    console.warn('sig render failed', e);
  }

  // add header info at top of cloned node
  const headerDiv = document.createElement('div');
  headerDiv.style.display='flex';
  headerDiv.style.justifyContent='space-between';
  headerDiv.style.alignItems='center';
  headerDiv.style.marginBottom='8px';
  headerDiv.innerHTML = `
    <div style="font-weight:800;color:${getComputedStyle(document.documentElement).getPropertyValue('--accent')||'#0a66c2'};font-size:18px">Router Inspection Report</div>
    <div style="text-align:right;font-size:12px;color:#657785">${headerFooter.company}<br>${headerFooter.date}</div>
  `;
  node.insertBefore(headerDiv, node.firstChild);

  // append to offscreen container
  const off = document.createElement('div'); off.style.position='fixed'; off.style.left='-9999px'; off.style.top='0';
  off.appendChild(node); document.body.appendChild(off);

  // render as canvas (scale for quality)
  const canvas = await html2canvas(node, { scale: 2, useCORS:true, logging:false, backgroundColor: null });
  const imgData = canvas.toDataURL('image/png');

  // create PDF
  const { jsPDF } = window.jspdf;
  const pdf = new jsPDF('p','mm','a4');
  const pageWidth = pdf.internal.pageSize.getWidth();
  const pageHeight = pdf.internal.pageSize.getHeight();

  // image dims in mm
  const imgProps = pdf.getImageProperties(imgData);
  const imgWidth = pageWidth;
  const imgHeight = (imgProps.height * imgWidth) / imgProps.width;

  if(imgHeight <= pageHeight){
    pdf.addImage(imgData,'PNG',0,0,imgWidth,imgHeight);
  } else {
    // split into pages
    const canvasPageHeight = Math.floor(canvas.height * (pageWidth / canvas.width));
    let renderedHeight = 0;
    const pageCanvas = document.createElement('canvas');
    pageCanvas.width = canvas.width;
    pageCanvas.height = Math.floor(canvas.height * (pageWidth / canvas.width) * (canvas.width / pageWidth));
    const pCtx = pageCanvas.getContext('2d');

    let position = 0;
    const pagePixelHeight = Math.floor(pageHeight * (canvas.width / pageWidth));
    while(position < canvas.height){
      pCtx.clearRect(0,0,pageCanvas.width,pageCanvas.height);
      pCtx.drawImage(canvas, 0, position, canvas.width, pagePixelHeight, 0, 0, canvas.width, pagePixelHeight);
      const pageData = pageCanvas.toDataURL('image/png');
      if(position === 0) pdf.addImage(pageData,'PNG',0,0,pageWidth,pageHeight);
      else pdf.addPage(), pdf.addImage(pageData,'PNG',0,0,pageWidth,pageHeight);
      position += pagePixelHeight;
    }
  }

  // cleanup
  document.body.removeChild(off);

  // save
  const filename = `RouterReport_${document.getElementById('nama').value||'report' }_${(new Date()).toISOString().slice(0,10)}.pdf`;
  pdf.save(filename);
});

/* ---------------------------
   Utility: escapeHtml
   ---------------------------*/
function escapeHtml(text){
  if(!text) return '';
  return text.replaceAll('&','&amp;').replaceAll('<','&lt;').replaceAll('>','&gt;');
}

/* ---------------------------
   Init: load defaults / draft / history
   ---------------------------*/
function init(){
  updateGenTime();
  // load history & db count
  updateDBCount();
  populateHistory();

  // check for draft
  const draft = JSON.parse(localStorage.getItem(HISTORY_KEY) || 'null');
  if(draft){
    if(confirm('Draft checklist ditemukan. Restore draft terakhir?')) restoreFromPayload(draft,true);
    else initItems();
  } else initItems();

  // auto timestamp refresh
  setInterval(updateGenTime, 60*1000);
}
init();
</script>
</body>
</html>
