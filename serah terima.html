<!doctype html>
<html lang="id">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Form Serah Terima Perangkat IT ‚Äî ZEPPELIN</title>

  <!-- Google font -->
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700;800&display=swap" rel="stylesheet">

  <style>
    :root{
      --zeppelin-red: #b61a1a;
      --zeppelin-orange: #ff7a2d;
      --gray-100: #f5f5f7;
      --gray-300: #d1d5db;
      --gray-600: #4b5563;
      --paper-width-mm: 210mm; /* A4 */
      --paper-height-mm: 297mm;
    }
    *{box-sizing:border-box;font-family:Inter,system-ui,-apple-system,"Segoe UI",Roboto,"Helvetica Neue",Arial;}
    body{margin:0;background:linear-gradient(180deg,#fafafa 0%, #f1f3f5 100%);padding:28px;color:#111;}
    .container{max-width:1100px;margin:0 auto;}
    .card{background:white;border-radius:12px;box-shadow:0 6px 30px rgba(16,24,40,0.08);padding:22px;}
    header.zepp{display:flex;align-items:center;gap:18px;border-bottom:1px solid #eee;padding-bottom:14px;margin-bottom:18px;}
    .logo-box{width:90px;height:90px;border-radius:8px;display:flex;align-items:center;justify-content:center;
             background:linear-gradient(135deg,var(--zeppelin-red),var(--zeppelin-orange));color:white;font-weight:800;font-size:18px;}
    .doc-title{flex:1;}
    .doc-title h1{margin:0;font-size:20px;letter-spacing:0.6px;color:var(--gray-600);}
    .doc-title .title-main{font-size:22px;font-weight:700;color:#111;margin-top:4px;}
    .meta{display:flex;gap:12px;flex-wrap:wrap;align-items:center;}
    .meta .chip{background:var(--gray-100);padding:6px 10px;border-radius:8px;font-size:13px;color:var(--gray-600);}

    /* form grid */
    .form-grid{display:grid;grid-template-columns:1fr 1fr 1fr;gap:12px;margin-bottom:16px;}
    .field{display:flex;flex-direction:column;gap:6px;}
    label{font-size:13px;color:#374151;font-weight:600;}
    input[type="text"], input[type="date"], input[type="number"], select, textarea{
      border:1px solid var(--gray-300);padding:10px;border-radius:8px;font-size:14px;background:white;
    }
    textarea{min-height:60px;resize:vertical;}

    /* table */
    .table-wrap{overflow:auto;border:1px solid var(--gray-300);border-radius:10px;}
    table{width:100%;border-collapse:collapse;font-size:14px;}
    thead th{background:#fbfbfb;padding:10px;border-bottom:1px solid var(--gray-300);text-align:left;font-weight:700;color:#111;}
    tbody td{padding:10px;border-bottom:1px solid #f0f0f0;vertical-align:top;}
    .no{width:48px;text-align:center;color:var(--gray-600);}
    .qty{width:80px;}
    .actions{width:90px;text-align:center;}
    .small-input{padding:8px;border-radius:6px;border:1px solid var(--gray-300);width:100%}

    .btn{
      display:inline-flex;align-items:center;gap:8px;border-radius:10px;padding:10px 14px;font-weight:700;cursor:pointer;border:none;
      box-shadow:0 6px 18px rgba(11,12,16,0.06);
    }
    .btn-primary{background:linear-gradient(90deg,var(--zeppelin-red),var(--zeppelin-orange));color:white;}
    .btn-ghost{background:transparent;border:1px solid var(--gray-300);color:#111;padding:9px 12px;}
    .btn-danger{background:#fef2f2;color:var(--zeppelin-red);border:1px solid #fca5a5;}

    .controls{display:flex;gap:10px;justify-content:flex-end;margin-top:14px;align-items:center;}
    .signature-row{display:grid;grid-template-columns:repeat(3,1fr);gap:12px;margin-top:18px;}
    .sig-card{background:#fff;border:1px solid var(--gray-300);padding:12px;border-radius:8px;text-align:center;}
    .sig-title{font-weight:700;color:#111;margin-bottom:8px;}
    .sig-canvas{background:white;border:1px dashed #e5e7eb;border-radius:6px;height:110px;touch-action:none;}
    .sig-meta{font-size:12px;color:#6b7280;margin-top:8px;}

    footer.form-foot{display:flex;justify-content:space-between;align-items:center;margin-top:18px;padding-top:12px;border-top:1px solid #f1f1f1;}
    footer .note{font-size:13px;color:#6b7280;}

    /* responsive */
    @media (max-width:900px){
      .form-grid{grid-template-columns:1fr 1fr;}
      .signature-row{grid-template-columns:1fr; }
    }

    /* print page (A4) style for PDF rendering */
    @media print{
      body{padding:0;background:white;}
      .container{max-width:var(--paper-width-mm);box-shadow:none;}
      .card{box-shadow:none;border-radius:0;padding:18mm;}
    }

  </style>
</head>
<body>
  <div class="container">
    <div class="card" id="printArea">

      <header class="zepp" role="banner">
        <div class="logo-box" aria-hidden="true">ZEPPELIN</div>
        <div class="doc-title">
          <div class="meta" style="justify-content:space-between;">
            <div>
              <h1>Form Serah Terima Perangkat IT</h1>
              <div class="title-main">PT ZEPPELIN ‚Äî IT Department</div>
            </div>
            <div style="text-align:right;">
              <div class="chip" id="docNo">No: ‚Äî</div>
              <div style="height:6px"></div>
              <div class="chip" id="createdAt">Tanggal: ‚Äî</div>
            </div>
          </div>
        </div>
      </header>

      <section style="margin-top:14px;">
        <div class="form-grid" role="form">
          <div class="field">
            <label>Nama User</label>
            <input type="text" id="namaUser" placeholder="Nama lengkap user / penerima">
          </div>
          <div class="field">
            <label>Departemen / Unit</label>
            <input type="text" id="unitUser" placeholder="Contoh: Finance, HR, R&D">
          </div>
          <div class="field">
            <label>Tanggal Serah Terima</label>
            <input type="date" id="tanggal" >
          </div>
        </div>

        <div style="display:flex;gap:12px;margin-bottom:12px;align-items:center;flex-wrap:wrap;">
          <div style="font-weight:700;color:#374151;">Daftar Perangkat</div>
          <div style="font-size:13px;color:#6b7280;">(Isi detail: Jenis, Model / Serial Number, Qty, Remark)</div>
        </div>

        <div class="table-wrap">
          <table id="deviceTable" aria-describedby="tableDescription">
            <thead>
              <tr>
                <th class="no">No</th>
                <th>Jenis Perangkat</th>
                <th>Model / Serial Number</th>
                <th class="qty">Qty</th>
                <th>Remark</th>
                <th class="actions">Aksi</th>
              </tr>
            </thead>
            <tbody id="deviceBody">
              <!-- initial row template inserted by JS -->
            </tbody>
          </table>
        </div>

        <div style="display:flex;justify-content:space-between;align-items:center;margin-top:12px;">
          <div>
            <button class="btn btn-ghost" id="addRowBtn">+ Tambah Baris</button>
            <button class="btn btn-ghost" id="importSample">Isi Sampel</button>
          </div>

          <div class="controls">
            <button class="btn btn-danger" id="resetBtn" title="Reset form ke baru">Buat Serah Terima Baru</button>
            <button class="btn btn-primary" id="printPdfBtn" title="Generate PDF yang rapi">üìÑ Cetak / Simpan PDF</button>
            <button class="btn btn-ghost" id="openPrint" title="Buka dialog print browser">üñ®Ô∏è Print</button>
          </div>
        </div>

        <div class="signature-row" style="margin-top:18px;">
          <div class="sig-card">
            <div class="sig-title">PIC Menyerahkan</div>
            <canvas class="sig-canvas" id="sig1"></canvas>
            <div style="margin-top:8px;">
              <button class="btn btn-ghost" data-clear="sig1">Bersihkan</button>
            </div>
            <div class="sig-meta">Nama / Jabatan / Tgl</div>
            <input type="text" id="sig1Name" placeholder="Nama & Jabatan" style="margin-top:8px;width:100%;border:1px solid var(--gray-300);padding:8px;border-radius:6px;">
          </div>

          <div class="sig-card">
            <div class="sig-title">PIC Mengetahui</div>
            <canvas class="sig-canvas" id="sig2"></canvas>
            <div style="margin-top:8px;">
              <button class="btn btn-ghost" data-clear="sig2">Bersihkan</button>
            </div>
            <div class="sig-meta">Nama / Jabatan / Tgl</div>
            <input type="text" id="sig2Name" placeholder="Nama & Jabatan" style="margin-top:8px;width:100%;border:1px solid var(--gray-300);padding:8px;border-radius:6px;">
          </div>

          <div class="sig-card">
            <div class="sig-title">User (Penerima)</div>
            <canvas class="sig-canvas" id="sig3"></canvas>
            <div style="margin-top:8px;">
              <button class="btn btn-ghost" data-clear="sig3">Bersihkan</button>
            </div>
            <div class="sig-meta">Nama / Tanda Tangan / Tgl</div>
            <input type="text" id="sig3Name" placeholder="Nama penerima" style="margin-top:8px;width:100%;border:1px solid var(--gray-300);padding:8px;border-radius:6px;">
          </div>
        </div>

        <footer class="form-foot">
          <div class="note">Catatan: Simpan file PDF ini sebagai bukti serah terima. Dokumen ini di-generate oleh sistem internal PT Zeppelin.</div>
          <div style="text-align:right;color:#6b7280;font-size:13px;">¬© PT ZEPPELIN ‚Äî IT Department</div>
        </footer>
      </section>

    </div>
  </div>

  <!-- External libs -->
  <script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js"></script>

  <script>
    /***** Helpers & initial data *****/
    const deviceBody = document.getElementById('deviceBody');
    const tanggal = document.getElementById('tanggal');
    const namaUser = document.getElementById('namaUser');
    const unitUser = document.getElementById('unitUser');
    const docNoEl = document.getElementById('docNo');
    const createdAtEl = document.getElementById('createdAt');

    // Initialize date to today
    function todayDateISO(){ const d=new Date(); return d.toISOString().slice(0,10); }
    tanggal.value = todayDateISO();

    // Document number auto: ZEP-YYYYMMDD-### stored in localStorage
    function genDocNo(){
      const key = 'zeppelin_serah_doc_count_' + new Date().toISOString().slice(0,10);
      let count = parseInt(localStorage.getItem(key) || '0',10) + 1;
      localStorage.setItem(key, String(count));
      const y = new Date().toISOString().slice(0,10).replace(/-/g,'');
      return `ZEP-${y}-${String(count).padStart(3,'0')}`;
    }

    function setDocHeader(newNo){
      docNoEl.textContent = 'No: ' + (newNo || genDocNo());
      createdAtEl.textContent = 'Tanggal: ' + (tanggal.value || todayDateISO());
    }

    // set initial doc no
    setDocHeader();

    // update createdAt when tanggal changes
    tanggal.addEventListener('change', ()=> createdAtEl.textContent = 'Tanggal: ' + tanggal.value);

    /***** Table row functions *****/
    let rowIndex = 0;
    function addRow(data){
      rowIndex++;
      const tr = document.createElement('tr');
      tr.dataset.index = rowIndex;
      tr.innerHTML = `
        <td class="no">${rowIndex}</td>
        <td><input type="text" class="small-input device-type" placeholder="Laptop / PC / RAM / SSD / Keyboard" value="${data?.type || ''}"></td>
        <td><input type="text" class="small-input device-model" placeholder="Model / Serial Number" value="${data?.model || ''}"></td>
        <td class="qty"><input type="number" class="small-input device-qty" min="1" value="${data?.qty||1}"></td>
        <td><input type="text" class="small-input device-remark" placeholder="Keterangan" value="${data?.remark || ''}"></td>
        <td class="actions">
          <button class="btn btn-ghost" data-action="move-up" title="Pindah ke atas">‚Üë</button>
          <button class="btn btn-ghost" data-action="move-down" title="Pindah ke bawah">‚Üì</button>
          <button class="btn btn-danger" data-action="delete" title="Hapus baris">Hapus</button>
        </td>
      `;
      deviceBody.appendChild(tr);
      updateRowNumbers();
    }

    function updateRowNumbers(){
      Array.from(deviceBody.children).forEach((tr,i)=> tr.querySelector('.no').textContent = i+1);
    }

    // initial single blank row
    addRow();

    document.getElementById('addRowBtn').addEventListener('click', ()=> addRow());
    document.getElementById('importSample').addEventListener('click', ()=>{
      // sample data
      addRow({type:'Laptop', model:'Dell Latitude 7420 / SN: DL7420-12345', qty:1, remark:'Stok baru'});
      addRow({type:'Docking Station', model:'Dell WD19', qty:1, remark:''});
      addRow({type:'RAM', model:'Corsair 16GB DDR4', qty:2, remark:'Upgrade'});
      addRow({type:'SSD', model:'Samsung 970 EVO 500GB', qty:1, remark:'S/N: S3Z...'});
    });

    deviceBody.addEventListener('click', (e)=>{
      const btn = e.target.closest('button');
      if(!btn) return;
      const action = btn.dataset.action;
      const tr = btn.closest('tr');
      if(action === 'delete'){
        tr.remove();
        updateRowNumbers();
      } else if(action === 'move-up'){
        const prev = tr.previousElementSibling;
        if(prev) deviceBody.insertBefore(tr, prev);
        updateRowNumbers();
      } else if(action === 'move-down'){
        const next = tr.nextElementSibling;
        if(next) deviceBody.insertBefore(next, tr);
        updateRowNumbers();
      }
    });

    /***** Signature pads (simple, no external lib) *****/
    function makeSignature(canvasId){
      const canvas = document.getElementById(canvasId);
      const ctx = canvas.getContext('2d');
      function fit(){
        const rect = canvas.getBoundingClientRect();
        canvas.width = rect.width * devicePixelRatio;
        canvas.height = rect.height * devicePixelRatio;
        ctx.scale(devicePixelRatio, devicePixelRatio);
        ctx.lineCap = 'round';
        ctx.lineJoin = 'round';
        ctx.lineWidth = 2.2;
        ctx.strokeStyle = '#111';
      }
      fit();
      window.addEventListener('resize', fit);

      let drawing = false;
      let last = null;

      function pointerDown(e){
        drawing = true;
        last = getPoint(e);
      }
      function pointerMove(e){
        if(!drawing) return;
        const p = getPoint(e);
        ctx.beginPath();
        ctx.moveTo(last.x, last.y);
        ctx.lineTo(p.x, p.y);
        ctx.stroke();
        last = p;
      }
      function pointerUp(){
        drawing = false;
        last = null;
      }
      function getPoint(e){
        const r = canvas.getBoundingClientRect();
        const clientX = (e.touches ? e.touches[0].clientX : e.clientX);
        const clientY = (e.touches ? e.touches[0].clientY : e.clientY);
        return { x: clientX - r.left, y: clientY - r.top };
      }
      canvas.addEventListener('pointerdown', pointerDown);
      canvas.addEventListener('pointermove', pointerMove);
      window.addEventListener('pointerup', pointerUp);
      canvas.addEventListener('touchstart', (e)=>{ e.preventDefault(); }, {passive:false});

      return {
        clear: ()=>{
          ctx.clearRect(0,0,canvas.width,canvas.height);
        },
        toDataURL: ()=> {
          // return trimmed image with white background
          const tmp = document.createElement('canvas');
          tmp.width = canvas.width;
          tmp.height = canvas.height;
          const tctx = tmp.getContext('2d');
          tctx.fillStyle = '#fff';
          tctx.fillRect(0,0,tmp.width,tmp.height);
          tctx.drawImage(canvas,0,0);
          // scale down to element-size for embedding
          const img = tmp.toDataURL('image/png');
          return img;
        },
        isEmpty: ()=>{
          const blank = document.createElement('canvas');
          blank.width = canvas.width;
          blank.height = canvas.height;
          return canvas.toDataURL() === blank.toDataURL();
        }
      };
    }

    const pad1 = makeSignature('sig1');
    const pad2 = makeSignature('sig2');
    const pad3 = makeSignature('sig3');

    document.querySelectorAll('[data-clear]').forEach(btn=>{
      btn.addEventListener('click', ()=> {
        const id = btn.dataset.clear;
        if(id === 'sig1') pad1.clear();
        if(id === 'sig2') pad2.clear();
        if(id === 'sig3') pad3.clear();
      });
    });


    /***** PDF generation (html2canvas + jsPDF) *****/
    
    async function generatePDF(){
      const rows = Array.from(deviceBody.querySelectorAll('tr'));
      if(rows.length === 0){
        alert('Tabel perangkat kosong. Tambahkan minimal 1 baris.');
        return;
      }

      const meta = {
        docNo: docNoEl.textContent.replace('No: ',''),
        tanggal: tanggal.value || todayDateISO(),
        namaUser: namaUser.value || '-',
        unitUser: unitUser.value || '-'
      };

      const printArea = document.getElementById('printArea');
      const clone = printArea.cloneNode(true);
      clone.style.boxShadow = 'none';
      clone.querySelectorAll('.btn, [data-action], #importSample, #addRowBtn, #resetBtn, #openPrint, #printPdfBtn').forEach(n => n.remove());

      // Remove Aksi column and header in clone
      const aksiHeader = clone.querySelector('th.actions');
      if(aksiHeader) aksiHeader.remove();
      clone.querySelectorAll('td.actions').forEach(td => td.remove());

      function fillCloneSign(cloneEl, idCanvas, nameInputId){
        const sigRow = cloneEl.querySelector('.signature-row');
        if(sigRow){
          sigRow.style.gridTemplateColumns = 'repeat(3, 1fr)';
          sigRow.style.gap = '12px';
        }
        cloneEl.querySelectorAll('.sig-card').forEach(card => {
          card.style.display = 'flex';
          card.style.flexDirection = 'column';
          card.style.alignItems = 'center';
          card.style.justifyContent = 'flex-start';
          card.style.padding = '12px';
        });
        const canvas = cloneEl.querySelector('#' + idCanvas);
        if(canvas){
          const img = document.createElement('img');
          const data = (idCanvas === 'sig1') ? pad1.toDataURL() : (idCanvas === 'sig2' ? pad2.toDataURL() : pad3.toDataURL());
          img.src = data;
          img.style.width = '70px';
          img.style.height = '70px';
          img.style.objectFit = 'contain';
          img.style.display = 'block';
          img.style.margin = '0 auto';
          img.style.border = '1px solid #e5e7eb';
          img.style.borderRadius = '6px';
          canvas.parentNode.replaceChild(img, canvas);
        }
        const nameInput = cloneEl.querySelector('#' + nameInputId);
        if(nameInput){
          const txt = document.createElement('div');
          txt.style.marginTop = '8px';
          txt.style.fontSize = '13px';
          txt.style.color = '#111';
          txt.style.textAlign = 'center';
          txt.textContent = nameInput.value || '-';
          nameInput.parentNode.replaceChild(txt, nameInput);
        }
      }
      fillCloneSign(clone, 'sig1', 'sig1Name');
      fillCloneSign(clone, 'sig2', 'sig2Name');
      fillCloneSign(clone, 'sig3', 'sig3Name');

      const liveRows = Array.from(deviceBody.children);
      const cloneTableBody = clone.querySelector('#deviceBody');
      cloneTableBody.innerHTML = '';
      liveRows.forEach((r, idx)=>{
        const type = r.querySelector('.device-type').value || '-';
        const model = r.querySelector('.device-model').value || '-';
        const qty = r.querySelector('.device-qty').value || '1';
        const remark = r.querySelector('.device-remark').value || '-';
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td class="no" style="padding:8px;text-align:center;">${idx+1}</td>
          <td style="padding:8px">${escapeHtml(type)}</td>
          <td style="padding:8px">${escapeHtml(model)}</td>
          <td style="padding:8px;text-align:center">${escapeHtml(qty)}</td>
          <td style="padding:8px">${escapeHtml(remark)}</td>
        `;
        cloneTableBody.appendChild(tr);
      });

      const wrapper = document.createElement('div');
      wrapper.style.background = 'white';
      wrapper.style.padding = '18mm';
      wrapper.style.width = '210mm';
      wrapper.style.boxSizing = 'border-box';
      wrapper.appendChild(clone);
      wrapper.style.position = 'fixed';
      wrapper.style.left = '-10000px';
      document.body.appendChild(wrapper);

      const scale = 2.2;
      const { jsPDF } = window.jspdf;
      const pdf = new jsPDF('p', 'mm', 'a4');
      const pageWidth = pdf.internal.pageSize.getWidth();
      const pageHeight = pdf.internal.pageSize.getHeight();

      // Capture total height of content
      const fullHeight = wrapper.scrollHeight;
      const viewportHeightPx = wrapper.offsetHeight;
      const pxToMm = (px) => px * 25.4 / (96 * scale);

      // Split long content into pages
      let renderedY = 0;
      while (renderedY < fullHeight) {
        const pageCanvas = await html2canvas(wrapper, {
          scale: scale,
          useCORS: true,
          logging: false,
          windowWidth: wrapper.scrollWidth,
          windowHeight: wrapper.scrollHeight,
          y: renderedY,
          height: viewportHeightPx
        });
        const imgData = pageCanvas.toDataURL('image/png');
        const imgHeightMm = pxToMm(pageCanvas.height);
        if (renderedY > 0) pdf.addPage();
        pdf.addImage(imgData, 'PNG', 0, 0, pageWidth, imgHeightMm);
        renderedY += viewportHeightPx - 50;
      }

      document.body.removeChild(wrapper);
      const safeName = (meta.namaUser || 'PT_Zeppelin').replace(/\s+/g,'_').replace(/[^\w\-_.]/g,'');
      pdf.save(`${meta.docNo || 'ZEP'}_${safeName}.pdf`);
    }


    function escapeHtml(s){
      if(!s) return '';
      return s.replaceAll('&','&amp;').replaceAll('<','&lt;').replaceAll('>','&gt;');
    }

    document.getElementById('printPdfBtn').addEventListener('click', ()=>{
      // basic check: at least one filled device type
      const anyType = Array.from(document.querySelectorAll('.device-type')).some(i => i.value.trim()!=='');
      if(!anyType && !confirm('Sepertinya semua "Jenis Perangkat" kosong. Lanjutkan generate PDF kosong?')) return;
      generatePDF().catch(err=>{ console.error(err); alert('Gagal generate PDF. Cek console untuk detail.');});
    });

    /***** Print dialog (browser) *****/
    document.getElementById('openPrint').addEventListener('click', ()=>{
      // hide controls then print
      const controls = document.querySelectorAll('.btn, #importSample, #addRowBtn, #resetBtn, #openPrint, #printPdfBtn');
      controls.forEach(n => n.style.display = 'none');
      window.print();
      controls.forEach(n => n.style.display = '');
    });

    /***** Reset / New form *****/
    document.getElementById('resetBtn').addEventListener('click', ()=>{
      if(!confirm('Buat serah terima baru? Semua input saat ini akan dihapus (nomor dokumen baru akan dibuat).')) return;
      // clear fields
      namaUser.value = '';
      unitUser.value = '';
      tanggal.value = todayDateISO();
      // reset table
      deviceBody.innerHTML = '';
      rowIndex = 0;
      addRow();
      // clear sigs
      pad1.clear(); pad2.clear(); pad3.clear();
      document.getElementById('sig1Name').value = '';
      document.getElementById('sig2Name').value = '';
      document.getElementById('sig3Name').value = '';
      // new doc no
      setDocHeader(genDocNo());
    });

    /***** Utility: auto-update docNo initially if missing *****/
    if(docNoEl.textContent.includes('‚Äî')) setDocHeader();

    /***** Accessibility / small niceties: keyboard shortcuts *****/
    window.addEventListener('keydown', (e)=>{
      if((e.ctrlKey || e.metaKey) && e.key.toLowerCase() === 's'){
        e.preventDefault();
        document.getElementById('printPdfBtn').click();
      }
    });

    /***** END script *****/
  </script>
</body>
</html>
