<!doctype html>
<html lang="id">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>File Analyzer Pro â€” Detail Excel (Patched)</title>
  <style>
    :root { font-family: 'Inter', system-ui, sans-serif; }
    body { margin:0; background:#1e293b; color:#f8fafc; padding:32px; }
    .container { max-width:1200px; margin:0 auto; background:#334155; padding:32px; border-radius:16px; box-shadow:0 10px 25px rgba(0,0,0,0.4); }
    h1 { font-size:28px; margin-bottom:4px; color:#94a3b8; }
    p.lead { color:#94a3b8; margin:0 0 24px; font-size:16px; }
    .controls { display:flex; flex-wrap:wrap; gap:16px; margin-bottom:24px; background:#475569; padding:16px; border-radius:12px; }
    input[type=file] { padding:10px; border:1px solid #64748b; border-radius:8px; background:#1e293b; color:#fff; }
    button.btn { background:#0ea5e9; color:#fff; border:0; padding:10px 18px; border-radius:8px; cursor:pointer; font-weight:600; transition: background 0.2s; }
    button.btn:hover { background:#0284c7; }
    button.btn.download { background:#10b981; } 
    button.btn.download:hover { background:#059669; }
    button.btn.warn { background:#f43f5e; }
    .stat-card { background:#475569; padding:16px; border-radius:12px; text-align:center; flex-grow:1; min-width:150px; box-shadow:0 4px 8px rgba(0,0,0,0.2); }
    .stat-card .small { font-size:13px; color:#cbd5e1; margin-bottom:4px; }
    .stat-card div:last-child { font-size:20px; font-weight:700; color:#fff; }
    .stats { display:flex; flex-wrap:wrap; gap:16px; margin-bottom:30px; }
    .sheet-card, .formula-card { background:#475569; border:1px solid #64748b; border-radius:12px; margin-bottom:16px; box-shadow:0 4px 10px rgba(0,0,0,0.2); }
    .sheet-header { background:#334155; padding:14px 20px; border-bottom:1px solid #64748b; cursor:pointer; display:flex; justify-content:space-between; align-items:center; border-top-left-radius:12px; border-top-right-radius:12px; }
    .sheet-body { padding:20px; display:none; }
    table { width:100%; border-collapse:collapse; margin-bottom:16px; }
    th, td { text-align:left; padding:10px; border-bottom:1px solid #64748b; color:#f8fafc; }
    th { color:#cbd5e1; font-weight:600; background:#334155; }
    pre { background:#1e293b; color:#94a3b8; padding:16px; border-radius:10px; overflow-x:auto; font-size:14px; }
    .toggle { transition:0.3s ease; transform:rotate(0deg); }
    .toggle.open { transform:rotate(90deg); color:#0ea5e9; }
    .footer { margin-top:30px; font-size:13px; color:#64748b; text-align:center; }
    .chart-container { width:100%; max-height:350px; margin-top:20px; margin-bottom:30px; padding:20px; background:#475569; border-radius:12px; box-shadow:0 4px 8px rgba(0,0,0,0.2); }
    .formula-card h3 { padding:14px 20px; margin:0; border-bottom:1px solid #64748b; background:#334155; border-top-left-radius:12px; border-top-right-radius:12px; color:#cbd5e1; }
    .formula-card ul { list-style-type:none; padding:0 20px 10px; }
    .formula-card li { border-bottom:1px dashed #64748b; padding:10px 0; }
    .formula-card li:last-child { border-bottom:none; }
    .error-msg { color:#f87171; font-weight:600; margin-right:8px; }
    .suggestion { color:#4ade80; font-style:italic; }
    .small-muted { color:#94a3b8; font-size:13px; }
    .fix-badge { background:#0ea5e9; color:white; padding:2px 8px; border-radius:8px; font-size:12px; margin-left:8px; }
  </style>
</head>
<body>
  <div class="container">
    <h1><span style="color:#0ea5e9;">File</span> Analyzer Pro ðŸ“Š â€” Patched</h1>
    <p class="lead">Unggah file Excel (.xlsx, .xls, .csv) untuk analisis struktur, statistik, dan deteksi rumus (termasuk rumus yang salah/typo).</p>

    <div class="controls">
      <input id="fileInput" type="file" accept=".xlsx,.xls,.csv" />
      <button id="analyzeBtn" class="btn">Analisis File</button>
      <button id="applyAndDownloadBtn" class="btn download" style="display:none;">Terapkan Perbaikan & Unduh (.xlsx)</button>
      <button id="clearBtn" class="btn" style="background:#64748b">Bersihkan</button>
    </div>

    <div id="fileInfo" style="display:none">
      <h2>Ringkasan File</h2>
      <div class="stats">
        <div class="stat-card"><div class="small">Nama File</div><div id="fName"></div></div>
        <div class="stat-card"><div class="small">Ukuran</div><div id="fSize"></div></div>
        <div class="stat-card"><div class="small">Tipe</div><div id="fType"></div></div>
        <div class="stat-card"><div class="small">Jumlah Sheet</div><div id="fSheets"></div></div>
        <div class="stat-card"><div class="small">Total Kata</div><div id="fWords"></div></div>
      </div>

      <div id="chart" class="chart-container"></div>
      
      <h2>Analisis Rumus & Perbaikan (AI-Driven + Validator)</h2>
      <div id="formulaAnalysis" class="formula-card">
        <h3>Deteksi Rumus Bermasalah</h3>
        <ul id="formulaIssues">
          <li class="small-muted">Menunggu analisis...</li>
        </ul>
      </div>

      <h2>Detail Sheet</h2>
      <div id="sheetsContainer"></div>
    </div>

    <div id="error" style="color:#f87171;margin-top:10px;font-weight:600;"></div>
  </div>

  <div class="footer">
    Aplikasi Analisis Excel oleh Gemini AI. Patch deteksi rumus oleh ChatGPT.
  </div>

  <script src="https://cdn.sheetjs.com/xlsx-latest/package/dist/xlsx.full.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script>
    function formatBytes(bytes){ const sizes=['B','KB','MB','GB']; if(bytes===0) return '0 B'; const i=parseInt(Math.floor(Math.log(bytes)/Math.log(1024))); return Math.round(bytes/Math.pow(1024,i),2)+' '+sizes[i]; }
    function countWords(str){ if(!str) return 0; return String(str).trim().split(/\s+/).filter(Boolean).length; }

    const analyzeBtn=document.getElementById('analyzeBtn');
    const clearBtn=document.getElementById('clearBtn');
    const downloadBtn = document.getElementById('applyAndDownloadBtn');
    let globalWorkbook = null;

    // --- Enhanced Validator Utilities ---

    // Minimal list of common Excel functions (extendable). Using uppercase keys for comparison.
    const EXCEL_FUNCTIONS = new Set([
      "SUM","AVERAGE","PRODUCT","MIN","MAX","IF","IFERROR","VLOOKUP","HLOOKUP","INDEX","MATCH","XLOOKUP","SUMIFS","COUNT","COUNTA","COUNTIF","COUNTIFS","ROUND","ROUNDUP","ROUNDDOWN","CONCATENATE","LEFT","RIGHT","MID","TRIM","LEN","SUBSTITUTE","INDIRECT","OFFSET","AND","OR","NOT","DATE","TODAY","YEAR","MONTH","DAY","TEXT","VALUE","SEARCH","FIND","ISNUMBER","ISERROR","ISBLANK","SUMPRODUCT","UNIQUE","FILTER","SORT","SEQUENCE","ARRAYTOTEXT"
    ]);

    // Helper: extract function names used in a formula (naive, but works for many cases)
    function extractFunctionNames(formula) {
        const names = [];
        // find words followed by '('
        const re = /([A-Za-z_][A-Za-z0-9_.]*)\s*\(/g;
        let m;
        while ((m = re.exec(formula)) !== null) {
            names.push(m[1].toUpperCase());
        }
        return Array.from(new Set(names));
    }

    // 1) Basic syntax checks
    function checkParenthesesBalance(formula) {
        let depth = 0;
        for (let ch of formula) {
            if (ch === "(") depth++;
            if (ch === ")") depth--;
            if (depth < 0) return { ok:false, msg: "Ada tanda ')' tanpa pasangan sebelumnya." };
        }
        if (depth !== 0) return { ok:false, msg: "Jumlah '(' dan ')' tidak seimbang." };
        return { ok:true };
    }

    function containsTrailingOperator(formula) {
        // ends with + - * / ^ & , or trailing comma inside function
        const trimmed = formula.trim();
        if (/[+\-*/^&\s,]$/.test(trimmed)) return true;
        return false;
    }

    function containsSemicolon(formula) {
        return formula.indexOf(';') !== -1;
    }

    function containsDivideByZero(formula) {
        // simple heuristics: /0 or /( ... - ... ) that evaluates to zero not detected, but direct /0 flagged
        return /\/\s*0(\D|$)/.test(formula);
    }

    function isJustEquals(formula) {
        const t = formula.trim();
        return t === "=" || t === "";
    }

    function hasInvalidCharacters(formula) {
        // Excel accepts many chars; flag control characters or some unusual tokens
        return /[\u0000-\u001F]/.test(formula);
    }

    function detectUnknownFunctions(formula) {
        const used = extractFunctionNames(formula);
        const unknown = used.filter(fn => !EXCEL_FUNCTIONS.has(fn));
        return unknown;
    }

    // 2) Basic auto-fix attempts for common typos
    function attemptAutoFix(formula) {
        let fixed = null;
        let note = null;
        const up = formula.toUpperCase();

        // Fix common typos
        const replacements = [
            [/SUMM\(/g, "SUM("],
            [/AVERAG(E?)/g, "AVERAGE"],
            [/AVERAGEE\(/g, "AVERAGE("],
            [/CONCATENATE\(/g, "CONCATENATE("],
            [/INDIREC\(/g, "INDIRECT("],
            [/XLOKUP\(/g, "XLOOKUP("],
            [/VLOOLKUP\(/g, "VLOOKUP("],
            [/;(?=[^\)]*(?:\)|$))/g, ","] // semicolon -> comma (risky: locale)
        ];

        let newFormula = formula;
        replacements.forEach(([re, rep]) => {
            newFormula = newFormula.replace(re, rep);
        });

        // Fix a trailing comma inside SUM(...) or remove trailing operator at end
        if (/,\s*\)/.test(newFormula)) {
            newFormula = newFormula.replace(/,\s*\)/g, ")");
        }
        if (/[+\-*/^&,\s]$/.test(newFormula.trim())) {
            // remove trailing operator (best-effort)
            newFormula = newFormula.trim().replace(/[+\-*/^&,\s]+$/, "");
        }

        // If we actually changed something, return suggestion
        if (newFormula !== formula) {
            fixed = newFormula;
            note = "Auto-fix applied (typo/separator/trailing operator fix). Periksa hasil.";
        }

        // If division by zero literal, suggest check
        if (containsDivideByZero(newFormula) && !fixed) {
            note = "Rumus berisi '/0' â€” periksa pembagian nol.";
        }

        // Parenthesis balance auto-close (very careful attempt)
        const balance = (() => {
            let d = 0; for (let ch of newFormula) { if (ch === "(") d++; if (ch === ")") d--; } return d;
        })();
        if (balance > 0 && !fixed) {
            // add missing ')' at end (best-effort)
            fixed = newFormula + ")".repeat(balance);
            note = "Menambahkan penutup ')' otomatis (best-effort).";
        }

        return { fixedFormula: fixed, note: note };
    }

    // 3) Comprehensive per-formula validator that returns list of issues + (optional) auto fix
    function validateFormulaString(formula) {
        // Normalize: formula might be stored without leading '=' in sheet object.f; but typically f excludes '=' in SheetJS.
        let original = String(formula || "");
        // If starts with '=' remove for analysis then keep a flag
        let hasEq = false;
        if (original.startsWith("=")) { hasEq = true; original = original.substring(1); }

        const issues = [];

        if (!original.trim()) {
            issues.push({code:"EMPTY_FORMULA", msg:"Rumus kosong atau hanya '='."});
            return { issues, suggestion:null, fixedFormula:null };
        }

        // basic checks
        if (hasInvalidCharacters(original)) issues.push({code:"INVALID_CHARS", msg:"Terdapat karakter non-printable/invalid."});
        const par = checkParenthesesBalance(original);
        if (!par.ok) issues.push({code:"PAREN_MISMATCH", msg:par.msg});
        if (containsSemicolon(original)) issues.push({code:"SEMICOLON_SEPARATOR", msg:"Terdapat ';' â€” periksa lokal pemisah argumen (koma vs titik koma)."});
        if (containsDivideByZero(original)) issues.push({code:"DIV_BY_ZERO", msg:"Pembagian oleh nol terdeteksi (literal '/0')."});
        if (containsTrailingOperator(original)) issues.push({code:"TRAILING_OPERATOR", msg:"Rumus berakhir dengan operator atau koma (mungkin incomplete)."});
        if (isJustEquals(original)) issues.push({code:"JUST_EQUALS", msg:"Hanya '=' ditemukan."});

        // Extract functions and detect unknowns
        const unknownFns = detectUnknownFunctions(original);
        if (unknownFns.length) {
            issues.push({code:"UNKNOWN_FUNCTION", msg:`Fungsi tidak dikenal/typo: ${unknownFns.join(", ")}.`});
        }

        // Very simple malformed patterns
        if (/[,]{2,}/.test(original)) issues.push({code:"DOUBLE_COMMA", msg:"Terdapat koma ganda atau argumen kosong."});
        if (/[^\)]\s*\)/.test(original) && par.ok === false) {} // placeholder

        // Try auto-fix when there are only fixable issues
        const attempted = attemptAutoFix((hasEq? "=":"") + original);
        let fixed = null;
        if (attempted.fixedFormula) {
            // convert to SheetJS .f content (without '=')
            fixed = attempted.fixedFormula.startsWith("=") ? attempted.fixedFormula.substring(1) : attempted.fixedFormula;
        }

        return { issues, suggestion: attempted.note || null, fixedFormula: fixed ? (fixed.startsWith("=")? fixed : "=" + fixed) : null };
    }

    // 4) Suggest fixes + overall orchestration
    function suggestFixes(formula) {
        // This function returns {suggestion, fixedFormula}
        try {
            const { issues, suggestion, fixedFormula } = validateFormulaString(formula);
            let joinedSuggestion = null;
            if (issues && issues.length) {
                joinedSuggestion = issues.map(i => i.msg).join(" ");
                if (suggestion) joinedSuggestion += " Saran: " + suggestion;
            } else if (suggestion) {
                joinedSuggestion = suggestion;
            } else {
                joinedSuggestion = null;
            }
            return { suggestion: joinedSuggestion, fixedFormula: fixedFormula };
        } catch (e) {
            return { suggestion: "Validator gagal memproses rumus.", fixedFormula: null };
        }
    }

    // Modified complexity detector: now we flag formulas with ANY issue OR complex patterns
    function analyzeFormulas(sheet, sheetName, range) {
        const issues = [];
        for(let R=range.s.r;R<=range.e.r;R++){
          for(let C=range.s.c;C<=range.e.c;C++){
            const addr=XLSX.utils.encode_cell({r:R,c:C});
            const cell=sheet[addr];
            if(!cell) continue;
            // cell.f is formula WITHOUT leading '=' for SheetJS; but sometimes has full string
            const formulaRaw = cell.f !== undefined ? (typeof cell.f==="string" ? cell.f : String(cell.f)) : (cell.w && typeof cell.w==="string" ? cell.w : null);
            if(!formulaRaw) continue;

            // Validate
            const result = suggestFixes(formulaRaw);
            // If result indicates issues (either suggestion exists or validation found unknown function)
            if (result.suggestion || (result.fixedFormula)) {
                issues.push({
                    sheet: sheetName,
                    cell: addr,
                    formula: formulaRaw,
                    suggestion: result.suggestion || "Terjadi potensi masalah pada rumus.",
                    fixedFormula: result.fixedFormula // may be null
                });
            } else {
                // also flag if contains obvious unknown functions even if no suggestion
                const unknownFns = detectUnknownFunctions(formulaRaw);
                if (unknownFns.length) {
                    issues.push({
                      sheet: sheetName,
                      cell: addr,
                      formula: formulaRaw,
                      suggestion: "Fungsi tidak dikenal: " + unknownFns.join(", "),
                      fixedFormula: null
                    });
                }
            }
          }
        }
        return issues;
    }

    // applyFixes: keep same approach but ensure we set .f correctly (SheetJS expects formula string without leading '=')
    function applyFixes(workbook, issues) {
        let fixesApplied = 0;
        const newWorkbook = XLSX.utils.book_new();

        workbook.SheetNames.forEach(sheetName => {
            const originalSheet = workbook.Sheets[sheetName];
            const newSheet = {};

            for (const key in originalSheet) {
                if (key.startsWith('!')) {
                    newSheet[key] = originalSheet[key];
                }
            }

            for (const cellAddress in originalSheet) {
                if (cellAddress.startsWith('!')) continue;
                const originalCell = originalSheet[cellAddress];
                let fixedCell = { ...originalCell };

                const fix = issues.find(i => i.sheet === sheetName && i.cell === cellAddress && i.fixedFormula);
                if (fix && fix.fixedFormula) {
                    // SheetJS formula string should NOT start with '='
                    const fstr = fix.fixedFormula.startsWith("=") ? fix.fixedFormula.substring(1) : fix.fixedFormula;
                    fixedCell.f = fstr;
                    // Clear value so Excel will recalc, set type unknown to let Excel decide
                    delete fixedCell.v;
                    // t should be left alone or removed to let Excel recalc; remove it if present
                    if (fixedCell.t) delete fixedCell.t;
                    fixesApplied++;
                }

                newSheet[cellAddress] = fixedCell;
            }

            XLSX.utils.book_append_sheet(newWorkbook, newSheet, sheetName);
        });

        console.log(`Perbaikan Rumus Diterapkan: ${fixesApplied}`);
        return newWorkbook;
    }

    // --- EVENT HANDLERS ---
    analyzeBtn.onclick=async()=>{
      const input=document.getElementById('fileInput');
      const err=document.getElementById('error'); err.textContent='';
      downloadBtn.style.display = 'none';
      if(!input.files.length){ err.textContent='Pilih file terlebih dahulu.'; return; }
      const file=input.files[0];
      const buf=await file.arrayBuffer();
      let workbook;
      try{ workbook=XLSX.read(buf,{type:'array', formulae: true}); }catch(e){ err.textContent='File rusak atau format tidak didukung.'; return; }
      
      globalWorkbook = workbook; 

      document.getElementById('fileInfo').style.display='block';
      document.getElementById('fName').textContent=file.name;
      document.getElementById('fSize').textContent=formatBytes(file.size);
      document.getElementById('fType').textContent=file.type||'â€“';
      document.getElementById('fSheets').textContent=workbook.SheetNames.length;

      let totalWords=0;
      const container=document.getElementById('sheetsContainer');
      container.innerHTML='';
      const formulaIssuesList = document.getElementById('formulaIssues');
      formulaIssuesList.innerHTML = '';
      let allFormulaIssues = [];

      const chartData=[];

      workbook.SheetNames.forEach((name,idx)=>{
        const sheet=workbook.Sheets[name];
        const range=sheet['!ref'] ? XLSX.utils.decode_range(sheet['!ref']) : {s: {r: -1, c: -1}, e: {r: -1, c: -1}};
        let rowCount=range.e.r - range.s.r + 1 > 0 ? range.e.r - range.s.r + 1 : 0;
        let colCount=range.e.c - range.s.c + 1 > 0 ? range.e.c - range.s.c + 1 : 0;
        let cellFilled=0, wordCount=0, numCount=0, textCount=0;

        const sheetIssues = analyzeFormulas(sheet, name, range);
        allFormulaIssues = allFormulaIssues.concat(sheetIssues.map(issue => ({...issue, sheet: name})));

        for(let R=range.s.r;R<=range.e.r;R++){
          for(let C=range.s.c;C<=range.e.c;C++){
            const addr=XLSX.utils.encode_cell({r:R,c:C});
            const cell=sheet[addr];
            if(!cell||cell.v===undefined) continue;
            cellFilled++;
            if(typeof cell.v==='string'){ textCount++; wordCount+=countWords(cell.v); }
            else if(typeof cell.v==='number'){ numCount++; wordCount++; }
            else wordCount++;
          }
        }
        totalWords+=wordCount;
        chartData.push({sheet:name,words:wordCount,cells:cellFilled});

        const card=document.createElement('div');
        card.className='sheet-card';
        card.innerHTML=`<div class="sheet-header"><span><strong>${name}</strong> | Baris: ${rowCount}, Kolom: ${colCount}</span><span class="toggle">â–¶</span></div><div class="sheet-body">
        <table><tbody>
        <tr><td>Baris Terpakai</td><td>${rowCount}</td></tr>
        <tr><td>Kolom Terpakai</td><td>${colCount}</td></tr>
        <tr><td>Sel Terisi</td><td>${cellFilled}</td></tr>
        <tr><td>Kata (perkiraan)</td><td>${wordCount}</td></tr>
        <tr><td>Teks</td><td>${textCount}</td></tr>
        <tr><td>Numerik</td><td>${numCount}</td></tr>
        </tbody></table>
        <p style="color:#94a3b8; margin-top:10px;">Pratinjau Data (8 Baris Pertama):</p>
        <pre id="preview-${idx}"></pre></div>`;
        container.appendChild(card);

        const body=card.querySelector('.sheet-body');
        const header=card.querySelector('.sheet-header');
        const toggle=card.querySelector('.toggle');
        header.onclick=()=>{ const open=body.style.display==='block'; body.style.display=open?'none':'block'; toggle.classList.toggle('open',!open); };

        try{
          const json=XLSX.utils.sheet_to_json(sheet,{header:1,raw:true});
          const preview=json.slice(0,8).map(r=>r.join(' | ')).join('\n');
          document.getElementById(`preview-${idx}`).textContent=preview||'(kosong)';
        }catch{}
      });

      document.getElementById('fWords').textContent=totalWords;

      // Update Formula Issues UI
      if (allFormulaIssues.length === 0) {
          formulaIssuesList.innerHTML = '<li><span class="suggestion">Tidak ada rumus yang mencurigakan terdeteksi.</span></li>';
      } else {
          // Sort: prioritize those with fixedFormula
          allFormulaIssues.sort((a,b) => (b.fixedFormula?1:0) - (a.fixedFormula?1:0));
          allFormulaIssues.forEach(issue => {
              const fixInfo = issue.fixedFormula ? ` <span class="fix-badge">Auto-Fix</span>` : '';
              const listItem = document.createElement('li');
              const suggestedHtml = issue.suggestion ? `<div class="small-muted">${issue.suggestion}</div>` : "";
              const fixedHtml = issue.fixedFormula ? `<div style="margin-top:6px;"><strong>Usulan Perbaikan:</strong> <code>${issue.fixedFormula}</code></div>` : "";
              listItem.innerHTML = `<div><span class="error-msg">[${issue.sheet}:${issue.cell}]</span> Rumus: <span style="color:#facc15;">${issue.formula}</span>${fixInfo}${suggestedHtml}${fixedHtml}</div>`;
              formulaIssuesList.appendChild(listItem);
          });
          // Tampilkan tombol Download jika ada isu yang dideteksi
          downloadBtn.style.display = 'block'; 
      }

      // Chart
      const ctx=document.createElement('canvas');
      const chartContainer=document.getElementById('chart');
      chartContainer.innerHTML='<h3 style="color:#cbd5e1; margin:0 0 10px 0;">Distribusi Data per Sheet</h3>';
      chartContainer.appendChild(ctx);
      new Chart(ctx,{type:'bar',data:{labels:chartData.map(d=>d.sheet),datasets:[{label:'Jumlah Kata',data:chartData.map(d=>d.words)},{label:'Sel Terisi',data:chartData.map(d=>d.cells)}]},options:{responsive:true, maintainAspectRatio: false, plugins:{legend:{position:'bottom', labels:{color:'#cbd5e1'}}, title:{display:true, text:'Perbandingan Jumlah Kata dan Sel Terisi', color:'#cbd5e1'}}, scales:{y:{ticks:{color:'#94a3b8'}, grid:{color:'#475569'}}, x:{ticks:{color:'#94a3b8'}, grid:{color:'#475569'}}}}});
      
      // Simpan isu ke tombol download
      downloadBtn.issues = allFormulaIssues;
    };

    downloadBtn.onclick = () => {
        if (!globalWorkbook || !downloadBtn.issues || downloadBtn.issues.length === 0) {
            alert('Tidak ada file atau perbaikan untuk diunduh.');
            return;
        }

        // Terapkan perbaikan ke workbook yang disimpan
        const fixedWorkbook = applyFixes(globalWorkbook, downloadBtn.issues);

        // Buat nama file baru
        const originalFileName = document.getElementById('fName').textContent.replace(/\.[^/.]+$/, "");
        const newFileName = `${originalFileName}_FIXED_${new Date().getTime()}.xlsx`;

        // Pemicu unduhan
        XLSX.writeFile(fixedWorkbook, newFileName);
        
        alert(`File ${newFileName} berhasil diunduh dengan perbaikan rumus!`);
    };

    clearBtn.onclick=()=>{ 
        document.getElementById('fileInfo').style.display='none'; 
        document.getElementById('fileInput').value=''; 
        document.getElementById('sheetsContainer').innerHTML=''; 
        document.getElementById('chart').innerHTML=''; 
        document.getElementById('error').textContent=''; 
        downloadBtn.style.display = 'none';
        globalWorkbook = null;
    };
  </script>
</body>
</html>
