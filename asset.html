<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="utf-8"/>
<meta content="width=device-width,initial-scale=1" name="viewport"/>
<title>Zeppelin â€” IT Asset Management (v2)</title>
<meta content="A professional IT Asset Management (ITAM) dashboard built with Firebase and Tailwind CSS." name="description"/>

<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">

<script src="https://cdn.tailwindcss.com"></script>

<script>
  tailwind.config = {
    theme: {
      extend: {
        colors: {
          // Palet Warna Semantik Standar & Profesional
          'primary': '#007bff', // BIRU - Default Highlight/Primary Action
          'primary-hover': '#0069d9',
          'accent': '#ff7a18', // ORANYE - Secondary Highlight/General Chart Color
          'light-bg': '#FFFFFF', // PUTIH - Background Utama
          'light-card': '#F8F8F8', // PUTIH MUDA - Background Card/Sidebar
          'light-border': '#E0E0E0', // ABU RINGAN - Border/Garis
          'dark-text': '#333333', // ABU GELAP - Teks Utama
          'dark-muted': '#777777', // ABU MUTE - Teks Sekunder
          'success': '#1db954', // HIJAU - Status Lulus QC
          'error': '#dc3545', // MERAH - Status Gagal QC
          'warning': '#007bff', // BIRU PRIMARY - Status Belum QC (Digunakan untuk kontras di chart)
        },
      },
    },
  };
</script>

<style>
  /* FONT DAN SCROLLBAR */
  html { font-family: 'Inter', system-ui, sans-serif; }
  ::-webkit-scrollbar { width: 8px; height: 8px; }
  ::-webkit-scrollbar-track { background: #f0f0f0; } 
  ::-webkit-scrollbar-thumb { background: #bbb; border-radius: 4px; }
  ::-webkit-scrollbar-thumb:hover { background: #999; }
  
  /* TRANSISI DAN MODAL */
  .page, .modal-backdrop {
    opacity: 0;
    visibility: hidden;
    pointer-events: none;
    transition: opacity 0.3s ease, visibility 0s 0.3s;
  }
  .page {
    position: absolute;
    top: 0; left: 0; width: 100%; height: 100%; overflow-y: auto; 
  }
  .modal-backdrop { display: flex; }
  .page.active, .modal-backdrop.active {
    opacity: 1;
    visibility: visible;
    pointer-events: auto;
    transition: opacity 0.3s ease;
  }
  .modal-backdrop > div {
    transform: scale(0.98); /* Lebih halus */
    transition: transform 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
  }
  .modal-backdrop.active > div {
    transform: scale(1);
  }
  
  /* ANIMASI SPINNER */
  .spinner {
    width: 40px; height: 40px;
    border: 4px solid #f3f3f3;
    border-top-color: #ff7a18; /* ACCENT */
    border-radius: 50%;
    animation: spin 1s linear infinite;
    margin: 0 auto 20px auto;
  }
  @keyframes spin { 100% { transform: rotate(360deg); } }

  /* KOMPONEN INTERAKTIF */
  .action-btn {
    padding: 6px 10px;
    font-size: 13px;
    font-weight: 600;
    border-radius: 6px;
    transition: all 0.2s ease;
  }
  .action-btn:hover {
     transform: scale(1.05);
  }

  .kpi-card {
    transition: transform 0.3s ease, box-shadow 0.3s ease;
    box-shadow: 0 4px 10px rgba(0,0,0,0.05); /* Shadow Profesional */
    will-change: transform;
  }
  .kpi-card:hover {
    transform: translateY(-3px);
    box-shadow: 0 8px 20px rgba(0,0,0,0.1); 
  }

  /* Input dan Search disederhanakan */
  .input, .search {
    border: 1px solid #E0E0E0; 
    background-color: #ffffff; 
    color: #333333;
    padding: 8px 12px; /* Padding lebih konsisten */
    border-radius: 6px;
    transition: border-color 0.2s ease, box-shadow 0.2s ease;
  }
  .input:focus, .search:focus {
    border-color: #007bff; /* Primary Blue di fokus */
    box-shadow: 0 0 0 3px rgba(0, 123, 255, 0.15);
  }
  
  /* Nav Item Aktif */
  .nav-item.active {
    position: relative;
    box-shadow: inset 4px 0 0px #ff7a18; /* ACCENT */
  }
</style>
</head>
<body class="bg-light-bg text-dark-text">

<div id="authVerificationScreen" class="fixed inset-0 z-50 flex items-center justify-center bg-light-bg text-dark-text p-4 text-center">
  <div class="bg-light-card p-8 md:p-12 rounded-lg shadow-2xl border border-light-border">
    <div class="spinner" id="authSpinner"></div>
    <h3 id="authMessage" class="text-xl font-bold mb-2 text-dark-text">Memverifikasi Sesi Admin...</h3>
    <p id="authSubMessage" class="text-dark-muted">Mengecek otentikasi Anda dengan Firebase...</p>
    <a href="../index.html" id="authBackButton" class="mt-6 inline-block rounded-md bg-error px-6 py-3 text-sm font-bold text-white shadow-md transition hover:bg-red-700" style="display: none;">Kembali ke Admin Dashboard</a>
  </div>
</div>

<header id="mobileHeader" class="md:hidden sticky top-0 z-40 bg-light-card border-b border-light-border p-4 flex items-center justify-between">
    <h2 class="text-xl font-bold text-dark-text">ZEPPELIN</h2>
    <button id="mobileNavToggle" class="text-dark-muted hover:text-dark-text transition p-1">
      <i class="fa-solid fa-bars text-xl"></i>
    </button>
</header>

<div id="mobileNavOverlay" class="fixed inset-0 z-40 bg-black/60 hidden md:hidden"></div>

<div id="appContainer" class="hidden min-h-screen md:flex">
  
  <nav id="sidebar" class="w-64 bg-light-card border-r border-light-border flex-shrink-0 flex flex-col fixed inset-y-0 left-0 z-50 transform -translate-x-full transition-transform duration-300 md:relative md:translate-x-0">
    <div class="p-6 text-center border-b border-light-border">
      <h2 class="text-2xl font-bold text-dark-text">ZEPPELIN</h2>
      <span class="text-sm font-semibold text-accent">IT ASSET MANAGER</span>
    </div>
    <ul class="py-6 space-y-2 flex-grow">
      <li>
        <a href="#dashboard" class="nav-item active flex items-center gap-3 px-6 py-3 text-dark-text font-semibold bg-light-bg">
          <i class="fa-solid fa-chart-pie w-5 text-center"></i>
          <span>Dashboard</span>
        </a>
      </li>
      <li>
        <a href="#assets" class="nav-item flex items-center gap-3 px-6 py-3 text-dark-muted font-semibold transition hover:text-dark-text hover:bg-light-bg">
          <i class="fa-solid fa-boxes-stacked w-5 text-center"></i>
          <span>Database Aset</span>
        </a>
      </li>
      <li>
        <a href="#vendors" class="nav-item flex items-center gap-3 px-6 py-3 text-dark-muted font-semibold transition hover:text-dark-text hover:bg-light-bg">
          <i class="fa-solid fa-store w-5 text-center"></i>
          <span>Vendor</span>
        </a>
      </li>
    </ul>
    <div class="p-6 border-t border-light-border">
      <div class="text-sm text-dark-muted">Logged in as:</div>
      <div id="userEmailDisplay" class="text-sm font-bold text-accent truncate">...</div>
      <button id="logoutBtn" class="mt-4 w-full text-center py-2 px-4 rounded-md bg-light-bg text-dark-muted font-semibold border border-light-border transition hover:bg-error/10 hover:text-error hover:border-error">
        <i class="fa-solid fa-right-from-bracket mr-2"></i>Logout
      </button>
    </div>
  </nav>

  <main class="flex-1 relative">
    
    <div id="page-dashboard" class="page active p-8 md:p-10">
      <h1 class="text-3xl font-bold text-dark-text mb-6">Dashboard</h1>
      
      <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6">
        <div class="kpi-card bg-light-card p-6 rounded-lg shadow-lg border border-light-border">
          <div class="flex items-center justify-between">
            <span class="text-sm font-semibold text-dark-muted uppercase">Total Item (Qty)</span>
            <i class="fa-solid fa-boxes-stacked text-2xl text-accent"></i>
          </div>
          <div id="kpi-total-items" class="text-4xl font-extrabold text-dark-text mt-4">0</div>
        </div>
        <div class="kpi-card bg-light-card p-6 rounded-lg shadow-lg border border-light-border">
          <div class="flex items-center justify-between">
            <span class="text-sm font-semibold text-dark-muted uppercase">Aset Unik</span>
            <i class="fa-solid fa-hashtag text-2xl text-primary"></i>
          </div>
          <div id="kpi-unique-assets" class="text-4xl font-extrabold text-dark-text mt-4">0</div>
        </div>
        <div class="kpi-card bg-light-card p-6 rounded-lg shadow-lg border border-light-border">
          <div class="flex items-center justify-between">
            <span class="text-sm font-semibold text-dark-muted uppercase">Lulus QC</span>
            <i class="fa-solid fa-check-double text-2xl text-success"></i>
          </div>
          <div id="kpi-lulus-qc" class="text-4xl font-extrabold text-dark-text mt-4">0</div>
        </div>
        <div class="kpi-card bg-light-card p-6 rounded-lg shadow-lg border border-light-border">
          <div class="flex items-center justify-between">
            <span class="text-sm font-semibold text-dark-muted uppercase">Gagal / Belum QC</span>
            <i class="fa-solid fa-triangle-exclamation text-2xl text-warning"></i>
          </div>
          <div id="kpi-fail-qc" class="text-4xl font-extrabold text-dark-text mt-4">0</div>
        </div>
      </div>

      <div class="grid grid-cols-1 lg:grid-cols-5 gap-6 mt-8">
        <div class="lg:col-span-3 bg-light-card p-6 rounded-lg shadow-lg border border-light-border">
          <h3 class="text-xl font-semibold text-dark-text mb-4">Aset Berdasarkan Tipe</h3>
          <canvas id="typeChart" height="150"></canvas>
        </div>
        <div class="lg:col-span-2 bg-light-card p-6 rounded-lg shadow-lg border border-light-border">
          <h3 class="text-xl font-semibold text-dark-text mb-4">Aset Berdasarkan Status QC</h3>
          <canvas id="qcStatusChart" height="150"></canvas>
        </div>
      </div>
    </div>

    <div id="page-assets" class="page p-8 md:p-10">
      <div class="flex items-center justify-between mb-6">
        <h1 class="text-3xl font-bold text-dark-text">Database Aset</h1>
        <button id="addAssetBtn" class="py-2 px-5 rounded-md bg-accent text-light-bg font-bold shadow-md">
          <i class="fa-solid fa-plus mr-2"></i>Tambah Aset Baru
        </button>
      </div>
      
      <div class="bg-light-card p-4 rounded-lg shadow-lg border border-light-border mb-6 flex flex-col md:flex-row md:items-center md:justify-between gap-4">
        <div class="relative flex-grow">
          <i class="fa-solid fa-search absolute left-4 top-1/2 -translate-y-1/2 text-dark-muted"></i>
          <input id="searchInput" type="text" placeholder="Cari berdasarkan nama, serial, lokasi, atau PIC..." class="search w-full light-bg pl-10 pr-4 py-2 rounded-md focus:ring-primary focus:ring-1">
        </div>
        
        <div class="flex flex-shrink-0 gap-3 flex-wrap flex-col md:flex-row"> 
          <select id="filterQcStatus" class="search light-bg rounded-md focus:ring-primary focus:ring-1">
            <option value="">Semua Status QC</option>
            <option value="Lulus QC">Lulus QC</option>
            <option value="Gagal QC">Gagal QC</option>
            <option value="Belum QC">Belum QC</option>
          </select>
          
          <select id="filterType" class="search light-bg rounded-md focus:ring-primary focus:ring-1">
            <option value="">Semua Tipe Aset</option>
            <optgroup label="Komputer">
              <option value="Laptop">Laptop</option>
              <option value="Desktop">Desktop</option>
              <option value="All-in-One (AIO)">All-in-One (AIO)</option>
              <option value="Server">Server</option>
            </optgroup>
            <optgroup label="Periferal">
              <option value="Monitor">Monitor</option>
              <option value="Keyboard">Keyboard</option>
              <option value="Mouse">Mouse</option>
              <option value="Printer">Printer</option>
              <option value="Scanner">Scanner</option>
              <option value="Projector">Projector</option>
              <option value="Headset/Speaker">Headset/Speaker</option>
              <option value="Webcam">Webcam</option>
            </optgroup>
            <optgroup label="Networking">
              <option value="Router">Router</option>
              <option value="Switch">Switch</option>
              <option value="Access Point">Access Point</option>
            </optgroup>
            <optgroup label="Komponen">
              <option value="Hard Drive">Hard Drive</option>
              <option value="SSD">SSD</option>
              <option value="RAM">RAM</option>
            </optgroup>
            <optgroup label="Lain-lain">
              <option value="UPS">UPS</option>
              <option value="Software">Software</option>
              <option value="Lainnya">Lainnya</option>
            </optgroup>
          </select>
          
          <button id="exportExcelBtn" class="py-2 px-4 rounded-md bg-light-card text-dark-muted font-semibold border border-light-border transition hover:bg-success/10 hover:text-success hover:border-success">
            <i class="fa-solid fa-file-excel mr-2"></i>Export
          </button>
        </div>
      </div>

      <div class="bg-light-card rounded-lg shadow-lg border border-light-border overflow-hidden">
        <div class="overflow-x-auto">
          <table class="w-full min-w-[1000px]">
            <thead class="bg-light-bg">
              <tr>
                <th class="p-4 text-left text-xs font-medium text-dark-muted uppercase tracking-wider">Nama Aset</th>
                <th class="p-4 text-left text-xs font-medium text-dark-muted uppercase tracking-wider">Tipe</th>
                <th class="p-4 text-left text-xs font-medium text-dark-muted uppercase tracking-wider">Status QC</th>
                <th class="p-4 text-center text-xs font-medium text-dark-muted uppercase tracking-wider">Qty</th>
                <th class="p-4 text-left text-xs font-medium text-dark-muted uppercase tracking-wider">Lokasi</th>
                <th class="p-4 text-left text-xs font-medium text-dark-muted uppercase tracking-wider">PIC</th>
                <th class="p-4 text-left text-xs font-medium text-dark-muted uppercase tracking-wider">Serial</th>
                <th class="p-4 text-right text-xs font-medium text-dark-muted uppercase tracking-wider">Aksi</th>
              </tr>
            </thead>
            <tbody id="asset-table-body" class="divide-y divide-light-border">
              <tr><td colspan="8" class="p-6 text-center text-dark-muted">Memuat data aset...</td></tr>
            </tbody>
          </table>
        </div>
      </div>
    </div>

    <div id="page-vendors" class="page p-8 md:p-10">
      <div class="flex items-center justify-between mb-6">
        <h1 class="text-3xl font-bold text-dark-text">Manajemen Vendor</h1>
        <button id="addVendorBtn" class="py-2 px-5 rounded-md bg-accent text-light-bg font-bold shadow-md">
          <i class="fa-solid fa-plus mr-2"></i>Tambah Vendor Baru
        </button>
      </div>

      <div class="bg-light-card p-4 rounded-lg shadow-lg border border-light-border mb-6 flex flex-col md:flex-row md:items-center md:justify-between gap-4">
        <div class="relative flex-grow">
          <i class="fa-solid fa-search absolute left-4 top-1/2 -translate-y-1/2 text-dark-muted"></i>
          <input id="searchVendorInput" type="text" placeholder="Cari berdasarkan nama vendor, kontak, atau email..." class="search w-full light-bg pl-10 pr-4 py-2 rounded-md focus:ring-primary focus:ring-1">
        </div>
      </div>

      <div class="bg-light-card rounded-lg shadow-lg border border-light-border overflow-hidden">
        <div class="overflow-x-auto">
          <table class="w-full min-w-[1000px]">
            <thead class="bg-light-bg">
              <tr>
                <th class="p-4 text-left text-xs font-medium text-dark-muted uppercase tracking-wider">Nama Vendor</th>
                <th class="p-4 text-left text-xs font-medium text-dark-muted uppercase tracking-wider">Kontak Person</th>
                <th class="p-4 text-left text-xs font-medium text-dark-muted uppercase tracking-wider">Telepon</th>
                <th class="p-4 text-left text-xs font-medium text-dark-muted uppercase tracking-wider">Email</th>
                <th class="p-4 text-left text-xs font-medium text-dark-muted uppercase tracking-wider">Alamat</th>
                <th class="p-4 text-right text-xs font-medium text-dark-muted uppercase tracking-wider">Aksi</th>
              </tr>
            </thead>
            <tbody id="vendor-table-body" class="divide-y divide-light-border">
              <tr><td colspan="6" class="p-6 text-center text-dark-muted">Memuat data vendor...</td></tr>
            </tbody>
          </table>
        </div>
      </div>
    </div>
    </main>
</div>

<div id="loader" class="modal-backdrop fixed inset-0 z-[99] bg-black/60 items-center justify-center">
  <div class="spinner"></div>
</div>

<div id="assetModal" class="modal-backdrop fixed inset-0 z-50 bg-black/60 items-center justify-center p-4">
  <div class="bg-light-card rounded-lg shadow-2xl border border-light-border w-full max-w-3xl max-h-[90vh] flex flex-col">
    <div class="flex items-center justify-between p-5 border-b border-light-border">
      <h3 id="assetModalTitle" class="text-xl font-bold text-dark-text">Tambah Aset Baru</h3>
      <button id="closeAssetModal" class="text-dark-muted hover:text-dark-text transition text-3xl font-light">&times;</button>
    </div>
    <form id="assetForm" class="flex-grow overflow-y-auto p-6 space-y-6">
      <input type="hidden" id="assetId">
      
      <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
        <div class="md:col-span-2">
          <label for="assetName" class="block text-sm font-medium text-dark-muted mb-1">Nama Aset*</label>
          <input type="text" id="assetName" required class="input w-full light-bg rounded-md focus:ring-primary focus:ring-1">
        </div>
        <div>
          <label for="qty" class="block text-sm font-medium text-dark-muted mb-1">Quantity*</label>
          <input type="number" id="qty" value="1" required class="input w-full light-bg rounded-md focus:ring-primary focus:ring-1">
        </div>
      </div>
      
      <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
        <div>
          <label for="type" class="block text-sm font-medium text-dark-muted mb-1">Tipe Aset*</label>
          
          <select id="type" required class="input w-full light-bg rounded-md focus:ring-primary focus:ring-1">
            <option value="">-- Pilih Tipe Aset --</option>
            <optgroup label="Komputer">
              <option value="Laptop">Laptop</option>
              <option value="Desktop">Desktop</option>
              <option value="All-in-One (AIO)">All-in-One (AIO)</option>
              <option value="Server">Server</option>
            </optgroup>
            <optgroup label="Periferal">
              <option value="Monitor">Monitor</option>
              <option value="Keyboard">Keyboard</option>
              <option value="Mouse">Mouse</option>
              <option value="Printer">Printer</option>
              <option value="Scanner">Scanner</option>
              <option value="Projector">Projector</option>
              <option value="Headset/Speaker">Headset/Speaker</option>
              <option value="Webcam">Webcam</option>
            </optgroup>
            <optgroup label="Networking">
              <option value="Router">Router</option>
              <option value="Switch">Switch</option>
              <option value="Access Point">Access Point</option>
            </optgroup>
            <optgroup label="Komponen">
              <option value="Hard Drive">Hard Drive</option>
              <option value="SSD">SSD</option>
              <option value="RAM">RAM</option>
            </optgroup>
            <optgroup label="Lain-lain">
              <option value="UPS">UPS</option>
              <option value="Software">Software</option>
              <option value="Lainnya">Lainnya</option>
            </optgroup>
          </select>
          
        </div>
        <div>
          <label for="serialNumber" class="block text-sm font-medium text-dark-muted mb-1">Serial Number</label>
          <input type="text" id="serialNumber" class="input w-full light-bg rounded-md focus:ring-primary focus:ring-1">
        </div>
      </div>
      
      <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
        <div>
          <label for="purchasePrice" class="block text-sm font-medium text-dark-muted mb-1">Harga Beli (Rp)</label>
          <input type="number" id="purchasePrice" placeholder="Contoh: 15000000" class="input w-full light-bg rounded-md focus:ring-primary focus:ring-1">
        </div>
        <div>
          <label for="vendorId" class="block text-sm font-medium text-dark-muted mb-1">Vendor Pembelian</label>
          <select id="vendorId" class="input w-full light-bg rounded-md focus:ring-primary focus:ring-1">
            <option value="">-- Tidak Ditentukan --</option>
            </select>
        </div>
      </div>
      
      <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
        <div>
          <label for="qcStatus" class="block text-sm font-medium text-dark-muted mb-1">Status QC*</label>
          <select id="qcStatus" required class="input w-full light-bg rounded-md focus:ring-primary focus:ring-1">
            <option value="Lulus QC">Lulus QC</option>
            <option value="Gagal QC">Gagal QC</option>
            <option value="Belum QC" selected>Belum QC</option>
          </select>
        </div>
        <div>
          <label for="location" class="block text-sm font-medium text-dark-muted mb-1">Lokasi</label>
          <input type="text" id="location" placeholder="e.g., Ruang IT, Lt. 3 Finance" class="input w-full light-bg rounded-md focus:ring-primary focus:ring-1">
        </div>
        <div>
          <label for="pic" class="block text-sm font-medium text-dark-muted mb-1">PIC (User)</label>
          <input type="text" id="pic" placeholder="Nama pengguna" class="input w-full light-bg rounded-md focus:ring-primary focus:ring-1">
        </div>
      </div>

      <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
        <div>
          <label for="purchaseDate" class="block text-sm font-medium text-dark-muted mb-1">Tgl. Pembelian</label>
          <input type="date" id="purchaseDate" class="input w-full light-bg rounded-md focus:ring-primary focus:ring-1">
        </div>
        <div>
          <label for="warrantyUntil" class="block text-sm font-medium text-dark-muted mb-1">Garansi Sampai</label>
          <input type="date" id="warrantyUntil" class="input w-full light-bg rounded-md focus:ring-primary focus:ring-1">
        </div>
        <div>
          <label for="software" class="block text-sm font-medium text-dark-muted mb-1">Software Terinstall</label>
          <input type="text" id="software" placeholder="e.g., Win 11, Office 2021" class="input w-full light-bg rounded-md focus:ring-primary focus:ring-1">
        </div>
      </div>
      
      <div>
        <label for="notes" class="block text-sm font-medium text-dark-muted mb-1">Catatan</label>
        <textarea id="notes" rows="3" placeholder="Spesifikasi, riwayat perbaikan singkat, dll..." class="input w-full light-bg rounded-md focus:ring-primary focus:ring-1"></textarea>
      </div>

    </form>
    
    <div class="flex items-center justify-end p-5 border-t border-light-border bg-light-bg">
      <button id="cancelAssetModal" type="button" class="py-2 px-5 rounded-md bg-light-bg text-dark-muted font-bold border border-light-border transition hover:bg-light-border">Batal</button>
      <button id="saveAssetBtn" type="submit" form="assetForm" class="ml-3 py-2 px-5 rounded-md bg-accent text-light-bg font-bold shadow-md">Simpan Aset</button>
    </div>
  </div>
</div>

<div id="viewAssetModal" class="modal-backdrop fixed inset-0 z-50 bg-black/60 items-center justify-center p-4">
  <div class="bg-light-card rounded-lg shadow-2xl border border-light-border w-full max-w-3xl max-h-[90vh] flex flex-col">
    <div class="flex items-center justify-between p-5 border-b border-light-border">
      <h3 id="viewModalTitle" class="text-xl font-bold text-dark-text">Detail Aset</h3>
      <button id="closeViewModal" class="text-dark-muted hover:text-dark-text transition text-3xl font-light">&times;</button>
    </div>
    <div class="flex-grow overflow-y-auto p-6 space-y-6">
      
      <div class="grid grid-cols-2 md:grid-cols-3 gap-6">
        <div class="info-group">
          <span class="text-sm font-medium text-dark-muted">Nama Aset</span>
          <p id="view-name" class="text-lg font-semibold text-dark-text"></p>
        </div>
        <div class="info-group">
          <span class="text-sm font-medium text-dark-muted">Tipe Aset</span>
          <p id="view-type" class="text-lg font-semibold text-dark-text"></p>
        </div>
        <div class="info-group">
          <span class="text-sm font-medium text-dark-muted">Quantity</span>
          <p id="view-qty" class="text-lg font-semibold text-dark-text"></p>
        </div>
        <div class="info-group">
          <span class="text-sm font-medium text-dark-muted">Serial Number</span>
          <p id="view-serial" class="text-lg font-semibold text-dark-text"></p>
        </div>
        <div class="info-group">
          <span class="text-sm font-medium text-dark-muted">Status QC</span>
          <p id="view-qcStatus" class="text-lg font-semibold text-dark-text"></p>
        </div>
        <div class="info-group">
          <span class="text-sm font-medium text-dark-muted">Lokasi</span>
          <p id="view-location" class="text-lg font-semibold text-dark-text"></p>
        </div>
        <div class="info-group">
          <span class="text-sm font-medium text-dark-muted">PIC</span>
          <p id="view-pic" class="text-lg font-semibold text-dark-text"></p>
        </div>
        <div class="info-group">
          <span class="text-sm font-medium text-dark-muted">Tgl. Pembelian</span>
          <p id="view-purchaseDate" class="text-lg font-semibold text-dark-text"></p>
        </div>
        <div class="info-group">
          <span class="text-sm font-medium text-dark-muted">Garansi Sampai</span>
          <p id="view-warrantyUntil" class="text-lg font-semibold text-dark-text"></p>
        </div>
        
        <div class="info-group">
          <span class="text-sm font-medium text-dark-muted">Harga Beli</span>
          <p id="view-purchasePrice" class="text-lg font-semibold text-dark-text"></p>
        </div>
        <div class="info-group">
          <span class="text-sm font-medium text-dark-muted">Vendor</span>
          <p id="view-vendor" class="text-lg font-semibold text-dark-text"></p>
        </div>
        
      </div>
      
      <div class="info-group">
        <span class="text-sm font-medium text-dark-muted">Software</span>
        <p id="view-software" class="text-lg font-semibold text-dark-text"></p>
      </div>

      <div>
        <span class="text-sm font-medium text-dark-muted">Catatan</span>
        <p id="view-notes" class="text-base text-dark-text bg-light-bg p-4 rounded-md mt-1 whitespace-pre-wrap"></p>
      </div>

      <div>
        <h4 class="text-lg font-semibold text-dark-text mb-2 border-t border-light-border pt-4">Riwayat Aset</h4>
        <div id="view-history" class="space-y-3 max-h-48 overflow-y-auto bg-light-bg p-4 rounded-md">
          <p class="text-dark-muted text-sm">Memuat riwayat...</p>
        </div>
      </div>

    </div>
  </div>
</div>

<div id="vendorModal" class="modal-backdrop fixed inset-0 z-50 bg-black/60 items-center justify-center p-4">
  <div class="bg-light-card rounded-lg shadow-2xl border border-light-border w-full max-w-2xl max-h-[90vh] flex flex-col">
    <div class="flex items-center justify-between p-5 border-b border-light-border">
      <h3 id="vendorModalTitle" class="text-xl font-bold text-dark-text">Tambah Vendor Baru</h3>
      <button id="closeVendorModal" class="text-dark-muted hover:text-dark-text transition text-3xl font-light">&times;</button>
    </div>
    <form id="vendorForm" class="flex-grow overflow-y-auto p-6 space-y-6">
      <input type="hidden" id="vendorId">
      
      <div>
        <label for="vendorName" class="block text-sm font-medium text-dark-muted mb-1">Nama Vendor*</label>
        <input type="text" id="vendorName" required class="input w-full light-bg rounded-md focus:ring-primary focus:ring-1">
      </div>
      
      <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
        <div>
          <label for="contactPerson" class="block text-sm font-medium text-dark-muted mb-1">Kontak Person</label>
          <input type="text" id="contactPerson" class="input w-full light-bg rounded-md focus:ring-primary focus:ring-1">
        </div>
        <div>
          <label for="phone" class="block text-sm font-medium text-dark-muted mb-1">Telepon</label>
          <input type="tel" id="phone" class="input w-full light-bg rounded-md focus:ring-primary focus:ring-1">
        </div>
      </div>
      
      <div>
        <label for="email" class="block text-sm font-medium text-dark-muted mb-1">Email</label>
        <input type="email" id="email" class="input w-full light-bg rounded-md focus:ring-primary focus:ring-1">
      </div>
      
      <div>
        <label for="address" class="block text-sm font-medium text-dark-muted mb-1">Alamat</label>
        <textarea id="address" rows="2" class="input w-full light-bg rounded-md focus:ring-primary focus:ring-1"></textarea>
      </div>
      
      <div>
        <label for="vendorNotes" class="block text-sm font-medium text-dark-muted mb-1">Catatan</label>
        <textarea id="vendorNotes" rows="3" placeholder="Produk/layanan yang disediakan, dll..." class="input w-full light-bg rounded-md focus:ring-primary focus:ring-1"></textarea>
      </div>

    </form>
    <div class="flex items-center justify-end p-5 border-t border-light-border bg-light-bg">
      <button id="cancelVendorModal" type="button" class="py-2 px-5 rounded-md bg-light-bg text-dark-muted font-bold border border-light-border transition hover:bg-light-border">Batal</button>
      <button id="saveVendorBtn" type="submit" form="vendorForm" class="ml-3 py-2 px-5 rounded-md bg-accent text-light-bg font-bold shadow-md">Simpan Vendor</button>
    </div>
  </div>
</div>

<div id="viewVendorModal" class="modal-backdrop fixed inset-0 z-50 bg-black/60 items-center justify-center p-4">
  <div class="bg-light-card rounded-lg shadow-2xl border border-light-border w-full max-w-2xl max-h-[90vh] flex flex-col">
    <div class="flex items-center justify-between p-5 border-b border-light-border">
      <h3 id="viewVendorModalTitle" class="text-xl font-bold text-dark-text">Detail Vendor</h3>
      <button id="closeViewVendorModal" class="text-dark-muted hover:text-dark-text transition text-3xl font-light">&times;</button>
    </div>
    <div class="flex-grow overflow-y-auto p-6 space-y-6">
      
      <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
        <div class="info-group">
          <span class="text-sm font-medium text-dark-muted">Nama Vendor</span>
          <p id="view-vendorName" class="text-lg font-semibold text-dark-text"></p>
        </div>
        <div class="info-group">
          <span class="text-sm font-medium text-dark-muted">Kontak Person</span>
          <p id="view-contactPerson" class="text-lg font-semibold text-dark-text"></p>
        </div>
        <div class="info-group">
          <span class="text-sm font-medium text-dark-muted">Telepon</span>
          <p id="view-phone" class="text-lg font-semibold text-dark-text"></p>
        </div>
        <div class="info-group">
          <span class="text-sm font-medium text-dark-muted">Email</span>
          <p id="view-email" class="text-lg font-semibold text-dark-text"></p>
        </div>
      </div>
      
      <div class="info-group">
        <span class="text-sm font-medium text-dark-muted">Alamat</span>
        <p id="view-address" class="text-lg font-semibold text-dark-text whitespace-pre-wrap"></p>
      </div>

      <div>
        <span class="text-sm font-medium text-dark-muted">Catatan</span>
        <p id="view-vendorNotes" class="text-base text-dark-text bg-light-bg p-4 rounded-md mt-1 whitespace-pre-wrap"></p>
      </div>
    </div>
  </div>
</div>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdn.jsdelivr.net/npm/xlsx/dist/xlsx.full.min.js"></script>

<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>

<script>
  // Konfigurasi Firebase Anda
  const firebaseConfig = {
      apiKey: "AIzaSyA9wgSalrlTcveIZi2i-WND86z1i9JYHKw",
      authDomain: "it-support-53eeb.firebaseapp.com",
      databaseURL: "https://it-support-53eeb-default-rtdb.firebaseio.com",
      projectId: "it-support-53eeb",
      storageBucket: "it-support-53eeb.firebasestorage.app",
      messagingSenderId: "573924501146",
      appId: "1:573924501146:web:12f34306ED675472322123",
      measurementId: "G-33K6DDE1VR"
  };
  
  // ID Admin
  const ADMIN_UID = "Ogy9lUbGHbSu8wYIYx2gQsTtFDF2";

  // --- Toast Helper (Global) ---
  function showToast(txt, isError = false){ 
    let t = document.getElementById('toastMsg'); 
    if(!t){ 
      t=document.createElement('div'); t.id='toastMsg'; 
      Object.assign(t.style, {
        position: 'fixed', right: '20px', bottom: '20px', zIndex: '10000',
        padding: '12px 20px', borderRadius: '8px', color: 'white',
        fontWeight: '600', boxShadow: '0 4px 12px rgba(0,0,0,0.3)',
        background: isError ? '#dc3545' : '#1db954' 
      });
      document.body.appendChild(t); 
    } 
    t.textContent=txt; t.style.opacity='1'; 
    setTimeout(()=> { t.style.opacity='0'; setTimeout(() => t.remove(), 300); }, isError ? 4000 : 2500); 
  }
  window.showToast = showToast;
    
  // --- Helper Functions (Lokal) ---
  function debounce(fn, ms){ let t; return function(){ clearTimeout(t); t=setTimeout(()=>fn.apply(this,arguments), ms||200); }; }
  function $(sel){ return document.querySelector(sel); }
  function $all(sel){ return Array.from(document.querySelectorAll(sel)); }
  
  // Fungsi Animasi Count-Up
  function animateCountUp(el, to) {
    const duration = 1200;
    const start = performance.now();
    const step = (timestamp) => {
      const progress = Math.min((timestamp - start) / duration, 1);
      const val = Math.floor(progress * to);
      if (el) el.textContent = val.toLocaleString('id-ID');
      if (progress < 1) window.requestAnimationFrame(step);
    };
    window.requestAnimationFrame(step);
  }
  
  function formatDate(isoString) {
    if (!isoString) return '-';
    try {
      return new Date(isoString).toLocaleDateString('id-ID', {
        day: '2-digit', month: 'short', year: 'numeric'
      });
    } catch (e) { return isoString; }
  }
  
  function formatPriceTable(price) {
      if (!price) return '-';
      price = Number(price);
      if (price >= 1000000) return `Rp ${(price / 1000000).toFixed(1)}jt`;
      if (price >= 1000) return `Rp ${(price / 1000).toFixed(0)}rb`;
      return `Rp ${price}`;
  }

  // --- Variabel Global Aplikasi ---
  let fb_app, fb_db, fb_auth, fb_userId, fb_assetsCollectionRef, fb_vendorsCollectionRef;
  let allAssetsCache = [];
  let allVendorsCache = []; 
  let assetListener = null;
  let vendorListener = null; 
  let typeChartInstance = null;
  let qcStatusChartInstance = null;
  
  // ==================================================================
  // TITIK MASUK UTAMA APLIKASI
  // ==================================================================
  window.addEventListener('load', () => {
    try {
      fb_app = firebase.initializeApp(firebaseConfig);
      fb_db = firebase.firestore();
      fb_auth = firebase.auth();
      console.log("Firebase App Initialized (v8). Waiting for Auth...");
      fb_auth.onAuthStateChanged(authVerificationHandler);
      attachUIListeners();
    } catch (e) {
      console.error("Firebase initialization failed:", e);
      showAuthError("Error Firebase", "Gagal inisialisasi Firebase: " + e.message);
    }
  });

  // ==================================================================
  // FUNGSI INTI
  // ==================================================================

  async function authVerificationHandler(user) {
    const els = {
      authScreen: $("#authVerificationScreen"),
      appContainer: $("#appContainer"),
      userEmailDisplay: $("#userEmailDisplay"),
      mobileHeader: $("#mobileHeader")
    };

    if (user && user.uid === ADMIN_UID) {
        console.log("Admin user authenticated:", user.uid);
        $("#authMessage").textContent = "Verifikasi Berhasil!";
        $("#authSubMessage").textContent = "Selamat datang, Admin. Memuat data...";
        
        fb_userId = user.uid;
        fb_assetsCollectionRef = fb_db.collection('users').doc(fb_userId).collection('assets_v2');
        fb_vendorsCollectionRef = fb_db.collection('users').doc(fb_userId).collection('vendors');

        els.userEmailDisplay.textContent = user.email;
        
        await Promise.all([
          loadAssetData(),
          loadVendorData() 
        ]);
        
        els.authScreen.style.display = 'none';
        els.appContainer.style.display = 'flex';
        if (els.mobileHeader) els.mobileHeader.classList.add('md:hidden'); 
        
    } else {
        if(user) {
            console.log("Access Denied. User is not admin:", user.uid);
            fb_auth.signOut().then(() => console.log("SignOut complete")).catch(e => console.error("SignOut failed:", e));
        } else {
            console.log("Access Denied. User not logged in.");
        }
        
        showAuthError("Akses Ditolak", "Anda harus login sebagai Admin untuk mengakses halaman ini.");
        
        fb_userId = null;
        els.authScreen.style.display = 'flex'; 
        els.appContainer.style.display = 'none'; 
        if (els.mobileHeader) els.mobileHeader.classList.add('md:hidden');
        $('#loader').style.display = 'none'; 
        if (assetListener) assetListener();
        if (vendorListener) vendorListener(); 
    }
  }

  function showAuthError(title, message) {
    $("#authSpinner").style.display = 'none';
    $("#authMessage").textContent = title;
    $("#authSubMessage").textContent = message;
    $("#authBackButton").style.display = 'inline-block';
  }

  function attachUIListeners() {
    // Navigasi Sidebar
    $all('.nav-item').forEach(item => {
      item.addEventListener('click', (e) => {
        e.preventDefault();
        const targetId = item.getAttribute('href').substring(1);
        
        // Mengganti class bg-dark-bg menjadi bg-light-bg
        $all('.nav-item').forEach(nav => nav.classList.remove('active', 'bg-light-bg'));
        $all('.page').forEach(page => page.classList.remove('active'));

        item.classList.add('active', 'bg-light-bg');
        $('#page-' + targetId).classList.add('active');
        
        const sidebar = $('#sidebar');
        const overlay = $('#mobileNavOverlay');
        if (window.innerWidth < 768 && sidebar && overlay) { 
            sidebar.classList.add('-translate-x-full');
            overlay.classList.add('hidden');
        }
      });
    });

    // --- Logout Button menggunakan Promise Chain ---
    $('#logoutBtn').addEventListener('click', (e) => {
      e.preventDefault();
      if (confirm("Apakah Anda yakin ingin logout?")) {
        fb_auth.signOut()
          .then(() => {
            console.log("Logout successful via listener.");
          })
          .catch((error) => {
            console.error("Logout failed:", error);
            showToast("Gagal logout: " + error.message, true);
          });
      }
    });
    // ---------------------------------------------
    
    // --- Listener Navigasi Mobile (Toggle) ---
    const sidebar = $('#sidebar');
    const toggleBtn = $('#mobileNavToggle');
    const overlay = $('#mobileNavOverlay');
    
    if (toggleBtn && sidebar && overlay) {
      toggleBtn.addEventListener('click', () => {
        sidebar.classList.toggle('-translate-x-full');
        overlay.classList.toggle('hidden');
      });
      
      overlay.addEventListener('click', () => {
        sidebar.classList.add('-translate-x-full');
        overlay.classList.add('hidden');
      });
    }

    // --- Listener Aset ---
    $('#addAssetBtn').addEventListener('click', () => openAssetModal());
    $('#closeAssetModal').addEventListener('click', () => $('#assetModal').classList.remove('active'));
    $('#cancelAssetModal').addEventListener('click', () => $('#assetModal').classList.remove('active'));
    $('#assetForm').addEventListener('submit', saveAsset);
    $('#closeViewModal').addEventListener('click', () => $('#viewAssetModal').classList.remove('active'));
    $('#searchInput').addEventListener('input', debounce(() => renderAssetTable(allAssetsCache), 300));
    $('#filterQcStatus').addEventListener('change', () => renderAssetTable(allAssetsCache));
    $('#filterType').addEventListener('change', () => renderAssetTable(allAssetsCache));
    $('#asset-table-body').addEventListener('click', handleTableActions);
    $('#exportExcelBtn').addEventListener('click', exportToExcel);

    // --- Listener Vendor ---
    $('#addVendorBtn').addEventListener('click', () => openVendorModal());
    $('#closeVendorModal').addEventListener('click', () => $('#vendorModal').classList.remove('active'));
    $('#cancelVendorModal').addEventListener('click', () => $('#vendorModal').classList.remove('active'));
    $('#vendorForm').addEventListener('submit', saveVendor);
    $('#closeViewVendorModal').addEventListener('click', () => $('#viewVendorModal').classList.remove('active'));
    $('#searchVendorInput').addEventListener('input', debounce(() => renderVendorTable(allVendorsCache), 300));
    $('#vendor-table-body').addEventListener('click', handleVendorTableActions);
  }

  // ==================================================================
  // FUNGSI PEMBANTU KODE UNIK
  // ==================================================================
  
  function getPrefixByType(type) {
      if (!type) return 'UNK';
      const map = {
          'Laptop': 'LAP', 'Desktop': 'DES', 'All-in-One (AIO)': 'AIO', 'Server': 'SRV',
          'Monitor': 'MON', 'Keyboard': 'KEY', 'Mouse': 'MOU', 'Printer': 'PRT',
          'Scanner': 'SCN', 'Projector': 'PRJ', 'Headset/Speaker': 'HDS', 'Webcam': 'WCM',
          'Router': 'RTR', 'Switch': 'SWT', 'Access Point': 'ACP',
          'Hard Drive': 'HDD', 'SSD': 'SSD', 'RAM': 'RAM',
          'UPS': 'UPS', 'Software': 'SFW', 'Lainnya': 'OTH' 
      };
      return map[type] || type.replace(/[^a-zA-Z]/g, '').substring(0, 3).toUpperCase();
  }

  function getPrefixByLocation(location) {
      if (!location) return 'XX';
      location = location.toUpperCase().trim();
      
      if (location.includes('IT')) return 'IT';
      if (location.includes('FINANCE') || location.includes('FIN')) return 'FN';
      if (location.includes('HR')) return 'HR';
      if (location.includes('SERVER')) return 'SV';
      if (location.includes('WAREHOUSE') || location.includes('WH')) return 'WH';
      
      return location.replace(/[^A-Z0-9]/g, '').substring(0, 2) || 'XX';
  }

  async function generateUniqueAssetCode(assetData) {
      const typePrefix = getPrefixByType(assetData.type);
      const locationPrefix = getPrefixByLocation(assetData.location);
      const uniqueKey = `${typePrefix}-${locationPrefix}`; 

      const counterRef = fb_db.collection('counters').doc(uniqueKey);
      let nextCode = '';

      try {
          await fb_db.runTransaction(async (transaction) => {
              const doc = await transaction.get(counterRef);

              let currentCount = 0;
              if (doc.exists) {
                  currentCount = doc.data().count;
              }

              const newCount = currentCount + 1;
              
              const paddedCount = newCount.toString().padStart(3, '0');
              nextCode = `${uniqueKey}-${paddedCount}`; 

              transaction.set(counterRef, { count: newCount, prefix: uniqueKey });
              
              console.log("Kode Aset unik baru:", nextCode);
          });
          
          return nextCode;
          
      } catch (e) {
          console.error("Gagal mendapatkan kode unik terstruktur:", e);
          showToast('Gagal membuat kode aset unik, menggunakan ID acak.', true);
          return fb_assetsCollectionRef.doc().id; 
      }
  }

  // ==================================================================
  // FUNGSI DATA ASET (CRUD & RENDER) - MODIFIED SAVE ASSET
  // ==================================================================

  async function saveAsset(e) {
    e.preventDefault();
    
    // --- PENCEGAHAN DOUBLE CLICK ---
    const saveBtn = $('#saveAssetBtn');
    if (saveBtn.disabled) return; 

    saveBtn.disabled = true; 
    saveBtn.textContent = 'Menyimpan...';
    saveBtn.classList.add('opacity-50', 'cursor-not-allowed');
    $('#loader').style.display = 'flex';
    // --------------------------------

    const assetData = {
      name: $('#assetName').value,
      qty: parseInt($('#qty').value) || 0,
      type: $('#type').value, 
      serial: $('#serialNumber').value,
      
      purchasePrice: parseInt($('#purchasePrice').value) || 0,
      vendorId: $('#vendorId').value,
      
      qcStatus: $('#qcStatus').value,
      location: $('#location').value,
      pic: $('#pic').value,
      purchaseDate: $('#purchaseDate').value,
      warrantyUntil: $('#warrantyUntil').value,
      software: $('#software').value,
      notes: $('#notes').value,
      lastUpdate: firebase.firestore.FieldValue.serverTimestamp()
    };
    
    if (!assetData.type) {
      showToast('Error: Tipe Aset harus dipilih', true);
      // --- RESET TOMBOL JIKA ADA ERROR VALIDASI ---
      saveBtn.disabled = false;
      saveBtn.textContent = 'Simpan Aset';
      saveBtn.classList.remove('opacity-50', 'cursor-not-allowed');
      $('#loader').style.display = 'none';
      return;
    }

    const assetId = $('#assetId').value;
    let logMessage = "";

    try {
      if (assetId) {
        // --- UPDATE ASET ---
        const docRef = fb_assetsCollectionRef.doc(assetId);
        const oldDoc = allAssetsCache.find(a => a.id === assetId);
        
        if (oldDoc && oldDoc.qcStatus !== assetData.qcStatus) {
          logMessage = `Status QC diubah dari '${oldDoc.qcStatus}' menjadi '${assetData.qcStatus}'.`;
        } else if (oldDoc && (oldDoc.location !== assetData.location || oldDoc.pic !== assetData.pic)) {
          logMessage = `Lokasi/PIC diubah dari '${oldDoc.location} (${oldDoc.pic})' menjadi '${assetData.location} (${assetData.pic})'.`;
        } else {
          logMessage = "Detail aset diperbarui.";
        }
        
        await docRef.update(assetData);
        await addAssetLog(assetId, logMessage, "Update");
        showToast('Aset berhasil diperbarui');
        
      } else {
        // --- CREATE ASET (LOGIKA KODE UNIK) ---
        assetData.createdAt = firebase.firestore.FieldValue.serverTimestamp();
        
        const newAssetCode = await generateUniqueAssetCode(assetData); 
        
        const docRef = fb_assetsCollectionRef.doc(newAssetCode); 
        await docRef.set(assetData); 
        
        logMessage = `Aset dibuat dengan ID kustom ${newAssetCode} dan status QC '${assetData.qcStatus}'.`;
        await addAssetLog(newAssetCode, logMessage, "Create");
        showToast(`Aset baru (${newAssetCode}) berhasil ditambahkan`);
      }
      
      $('#assetModal').classList.remove('active');
      
    } catch (e) {
      console.error("Error saving asset: ", e);
      showToast('Gagal menyimpan aset: ' + e.message, true);
    } finally {
      // --- RESET TOMBOL DAN LOADER ---
      saveBtn.disabled = false;
      saveBtn.textContent = 'Simpan Aset';
      saveBtn.classList.remove('opacity-50', 'cursor-not-allowed');
      $('#loader').style.display = 'none';
    }
  }

  function loadAssetData() {
    return new Promise((resolve, reject) => {
      if (assetListener) assetListener();
      $('#loader').style.display = 'flex';

      assetListener = fb_assetsCollectionRef.orderBy('name', 'asc').onSnapshot((snapshot) => {
          console.log(`(DATA ASET) Menerima ${snapshot.docs.length} dokumen.`);
          allAssetsCache = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                    
          renderAssetTable(allAssetsCache);
          updateDashboard(allAssetsCache);
          
          $('#loader').style.display = 'none';
          resolve();
      }, (error) => {
          console.error("Error listening to assets:", error);
          showToast('Gagal memuat data aset: ' + error.message, true);
          $('#loader').style.display = 'none';
          reject(error);
      });
    });
  }

  async function deleteAsset(id) {
    const asset = allAssetsCache.find(a => a.id === id);
    if (!asset) return showToast('Error: Aset tidak ditemukan.', true);

    if (!confirm(`Yakin ingin menghapus aset ini?\n\nNama: ${asset.name}\nSerial: ${asset.serial}\nID: ${asset.id}`)) return;
    
    $('#loader').style.display = 'flex';
    try {
      await fb_assetsCollectionRef.doc(id).delete();
      showToast('Aset berhasil dihapus');
    } catch (e) {
      console.error("Error deleting asset: ", e);
      showToast('Gagal menghapus aset: ' + e.message, true);
    } finally {
      $('#loader').style.display = 'none';
    }
  }
  
  async function addAssetLog(assetId, message, type) {
    if (!assetId) return;
    try {
      const logData = {
        message: message,
        type: type,
        timestamp: firebase.firestore.FieldValue.serverTimestamp(),
        adminEmail: fb_auth.currentUser.email
      };
      await fb_assetsCollectionRef.doc(assetId).collection('history').add(logData);
    } catch (e) { console.error("Error writing asset log: ", e); }
  }

  // ==================================================================
  // --- FUNGSI VENDOR (CRUD & RENDER) ---
  // ==================================================================

  async function saveVendor(e) {
    e.preventDefault();
    
    // --- PENCEGAHAN DOUBLE CLICK ---
    const saveBtn = $('#saveVendorBtn');
    if (saveBtn.disabled) return;
    
    saveBtn.disabled = true; 
    saveBtn.textContent = 'Menyimpan...';
    saveBtn.classList.add('opacity-50', 'cursor-not-allowed');
    $('#loader').style.display = 'flex';
    // --------------------------------

    const vendorData = {
      name: $('#vendorName').value,
      contact: $('#contactPerson').value,
      phone: $('#phone').value,
      email: $('#email').value,
      address: $('#address').value,
      notes: $('#vendorNotes').value,
      lastUpdate: firebase.firestore.FieldValue.serverTimestamp()
    };

    const vendorId = $('#vendorId').value;

    try {
      if (vendorId) {
        // --- UPDATE VENDOR ---
        const docRef = fb_vendorsCollectionRef.doc(vendorId);
        await docRef.update(vendorData);
        showToast('Data vendor berhasil diperbarui');
        
      } else {
        // --- CREATE VENDOR ---
        vendorData.createdAt = firebase.firestore.FieldValue.serverTimestamp();
        const docRef = await fb_vendorsCollectionRef.add(vendorData);
        showToast('Vendor baru berhasil ditambahkan');
      }
      
      $('#vendorModal').classList.remove('active');
      
    } catch (e) {
      console.error("Error saving vendor: ", e);
      showToast('Gagal menyimpan vendor: ' + e.message, true);
    } finally {
      // --- RESET TOMBOL DAN LOADER ---
      saveBtn.disabled = false;
      saveBtn.textContent = 'Simpan Vendor';
      saveBtn.classList.remove('opacity-50', 'cursor-not-allowed');
      $('#loader').style.display = 'none';
    }
  }

  function loadVendorData() {
    return new Promise((resolve, reject) => {
      if (vendorListener) vendorListener();
      
      vendorListener = fb_vendorsCollectionRef.orderBy('name', 'asc').onSnapshot((snapshot) => {
          console.log(`(DATA VENDOR) Menerima ${snapshot.docs.length} dokumen.`);
          allVendorsCache = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
          
          renderVendorTable(allVendorsCache);
          populateVendorDropdown(allVendorsCache); 
          resolve();
          
      }, (error) => {
          console.error("Error listening to vendors:", error);
          showToast('Gagal memuat data vendor: ' + error.message, true);
          reject(error);
      });
    });
  }

  async function deleteVendor(id) {
    const vendor = allVendorsCache.find(v => v.id === id);
    if (!vendor) return showToast('Error: Vendor tidak ditemukan.', true);

    if (!confirm(`Yakin ingin menghapus vendor ini?\n\nNama: ${vendor.name}`)) return;
    
    $('#loader').style.display = 'flex';
    try {
      await fb_vendorsCollectionRef.doc(id).delete();
      showToast('Vendor berhasil dihapus');
    } catch (e) {
      console.error("Error deleting vendor: ", e);
      showToast('Gagal menghapus vendor: ' + e.message, true);
    } finally {
      $('#loader').style.display = 'none';
    }
  }

  function renderVendorTable(vendors) {
    const tableBody = $('#vendor-table-body');
    if (!tableBody) return;
    
    const searchTerm = $('#searchVendorInput').value.toLowerCase();

    const filteredVendors = vendors.filter(vendor => {
      return !searchTerm ||
        (vendor.name && vendor.name.toLowerCase().includes(searchTerm)) ||
        (vendor.contact && vendor.contact.toLowerCase().includes(searchTerm)) ||
        (vendor.email && vendor.email.toLowerCase().includes(searchTerm));
    });

    if (filteredVendors.length === 0) {
      tableBody.innerHTML = `<tr><td colspan="6" class="p-6 text-center text-dark-muted">Tidak ada vendor yang ditemukan.</td></tr>`;
      return;
    }

    tableBody.innerHTML = filteredVendors.map(vendor => {
      return `
        <tr class="hover:bg-light-card">
          <td class="p-4 align-top">
            <div class="font-bold text-dark-text">${vendor.name || '-'}</div>
            <div class="text-xs text-dark-muted">${vendor.id}</div>
          </td>
          <td class="p-4 align-top text-sm text-dark-text">${vendor.contact || '-'}</td>
          <td class="p-4 align-top text-sm text-dark-text">${vendor.phone || '-'}</td>
          <td class="p-4 align-top text-sm text-dark-text">${vendor.email || '-'}</td>
          <td class="p-4 align-top text-sm text-dark-text">${(vendor.address || '-').substring(0, 50)}...</td>
          <td class="p-4 align-top text-right">
            <div class="flex items-center justify-end gap-2">
              <button data-action="view" data-id="${vendor.id}" class="action-btn bg-light-card text-dark-muted border border-light-border hover:border-primary hover:text-primary">Lihat</button>
              <button data-action="edit" data-id="${vendor.id}" class="action-btn bg-light-card text-dark-muted border border-light-border hover:border-accent hover:text-accent">Edit</button>
              <button data-action="delete" data-id="${vendor.id}" class="action-btn bg-light-card text-dark-muted border border-light-border hover:border-error hover:text-error">Hapus</button>
            </div>
          </td>
        </tr>
      `;
    }).join('');
  }

  function handleVendorTableActions(e) {
    const target = e.target.closest('button[data-action]');
    if (!target) return;
    const action = target.dataset.action;
    const id = target.dataset.id;
    const vendor = allVendorsCache.find(v => v.id === id);
    if (!vendor) return showToast('Error: Vendor tidak ditemukan.', true);

    if (action === 'view') openViewVendorModal(vendor);
    else if (action === 'edit') openVendorModal(vendor);
    else if (action === 'delete') deleteVendor(id);
  }

  function openVendorModal(vendor = null) {
    const modal = $('#vendorModal');
    $('#vendorForm').reset();
    
    // Reset tombol save saat modal dibuka
    const saveBtn = $('#saveVendorBtn');
    saveBtn.disabled = false;
    saveBtn.textContent = 'Simpan Vendor';
    saveBtn.classList.remove('opacity-50', 'cursor-not-allowed');
    
    if (vendor) {
      // --- MODE EDIT ---
      $('#vendorModalTitle').textContent = 'Edit Vendor';
      $('#vendorId').value = vendor.id;
      $('#vendorName').value = vendor.name || '';
      $('#contactPerson').value = vendor.contact || '';
      $('#phone').value = vendor.phone || '';
      $('#email').value = vendor.email || '';
      $('#address').value = vendor.address || '';
      $('#vendorNotes').value = vendor.notes || '';
    } else {
      // --- MODE TAMBAH ---
      $('#vendorModalTitle').textContent = 'Tambah Vendor Baru';
      $('#vendorId').value = '';
    }
    modal.classList.add('active');
  }

  function openViewVendorModal(vendor) {
    const modal = $('#viewVendorModal');
    
    $('#viewVendorModalTitle').textContent = `Detail: ${vendor.name}`;
    $('#view-vendorName').textContent = vendor.name || '-';
    $('#view-contactPerson').textContent = vendor.contact || '-';
    $('#view-phone').textContent = vendor.phone || '-';
    $('#view-email').textContent = vendor.email || '-';
    $('#view-address').textContent = vendor.address || '-';
    $('#view-vendorNotes').textContent = vendor.notes || '(Tidak ada catatan)';
    
    modal.classList.add('active');
  }
  
  // ==================================================================
  // FUNGSI RENDER & UI (LAINNYA)
  // ==================================================================

  function populateVendorDropdown(vendors) {
    const selectEl = $('#vendorId');
    if (!selectEl) return; 
    
    const currentVal = selectEl.value; 
    
    selectEl.innerHTML = '<option value="">-- Tidak Ditentukan --</option>'; 
    vendors.forEach(vendor => {
      const selected = (vendor.id === currentVal) ? 'selected' : '';
      selectEl.innerHTML += `<option value="${vendor.id}" ${selected}>${vendor.name}</option>`;
    });
  }

  function renderAssetTable(assets) {
    const tableBody = $('#asset-table-body');
    if (!tableBody) return;
    
    const searchTerm = $('#searchInput').value.toLowerCase();
    const qcStatusFilter = $('#filterQcStatus').value;
    const typeFilter = $('#filterType').value; 

    const filteredAssets = assets.filter(asset => {
      const searchMatch = !searchTerm ||
        (asset.name && asset.name.toLowerCase().includes(searchTerm)) ||
        (asset.serial && asset.serial.toLowerCase().includes(searchTerm)) ||
        (asset.pic && asset.pic.toLowerCase().includes(searchTerm)) ||
        (asset.location && asset.location.toLowerCase().includes(searchTerm)) ||
        (asset.id && asset.id.toLowerCase().includes(searchTerm)); 
      
      const qcStatusMatch = !qcStatusFilter || asset.qcStatus === qcStatusFilter;
      const typeMatch = !typeFilter || asset.type === typeFilter;

      return searchMatch && qcStatusMatch && typeMatch;
    });

    if (filteredAssets.length === 0) {
      tableBody.innerHTML = `<tr><td colspan="8" class="p-6 text-center text-dark-muted">Tidak ada aset yang ditemukan.</td></tr>`;
      return;
    }

    tableBody.innerHTML = filteredAssets.map(asset => {
      let statusClass = '';
      switch (asset.qcStatus) {
        case 'Lulus QC': statusClass = 'bg-success/20 text-success'; break;
        case 'Gagal QC': statusClass = 'bg-error/20 text-error'; break;
        case 'Belum QC': statusClass = 'bg-warning/20 text-warning'; break;
        default: statusClass = 'bg-light-border text-dark-muted';
      }

      return `
        <tr class="hover:bg-light-card">
          <td class="p-4 align-top">
            <div class="font-bold text-dark-text">${asset.name || '-'}</div>
            <div class="text-xs text-dark-muted">${asset.id}</div>
          </td>
          <td class="p-4 align-top text-sm text-dark-text">${asset.type || '-'}</td>
          <td class="p-4 align-top">
            <span class="px-3 py-1 text-xs font-bold rounded-full ${statusClass}">
              ${asset.qcStatus || '-'}
            </span>
          </td>
          <td class="p-4 align-top text-sm font-bold text-center text-dark-text">${asset.qty || 0}</td>
          <td class="p-4 align-top text-sm text-dark-text">${asset.location || '-'}</td>
          <td class="p-4 align-top text-sm text-dark-text">${asset.pic || '-'}</td>
          <td class="p-4 align-top text-sm font-mono text-dark-text">${asset.serial || '-'}</td>
          <td class="p-4 align-top text-right">
            <div class="flex items-center justify-end gap-2">
              <button data-action="view" data-id="${asset.id}" class="action-btn bg-light-card text-dark-muted border border-light-border hover:border-primary hover:text-primary">Lihat</button>
              <button data-action="edit" data-id="${asset.id}" class="action-btn bg-light-card text-dark-muted border border-light-border hover:border-accent hover:text-accent">Edit</button>
              <button data-action="delete" data-id="${asset.id}" class="action-btn bg-light-card text-dark-muted border border-light-border hover:border-error hover:text-error">Hapus</button>
            </div>
          </td>
        </tr>
      `;
    }).join('');
  }

  function updateDashboard(assets) {
    let totalItems = 0;
    let lulusQcCount = 0;
    let failQcCount = 0;
    let belumQcCount = 0;
    const typeCounts = {};
    const qcStatusCounts = {};

    assets.forEach(asset => {
      totalItems += (asset.qty || 0);
      
      if (asset.qcStatus === 'Lulus QC') lulusQcCount++;
      else if (asset.qcStatus === 'Gagal QC') failQcCount++;
      else if (asset.qcStatus === 'Belum QC') belumQcCount++;

      const type = asset.type || 'Lainnya';
      typeCounts[type] = (typeCounts[type] || 0) + 1;
      
      const status = asset.qcStatus || 'Unknown';
      qcStatusCounts[status] = (qcStatusCounts[status] || 0) + 1;
    });

    // Update KPI
    animateCountUp($('#kpi-total-items'), totalItems);
    animateCountUp($('#kpi-unique-assets'), assets.length);
    animateCountUp($('#kpi-lulus-qc'), lulusQcCount);
    animateCountUp($('#kpi-fail-qc'), (failQcCount + belumQcCount)); 

    // Update Chart Tipe (Bar)
    const typeCtx = $('#typeChart').getContext('2d');
    const typeLabels = Object.keys(typeCounts);
    const typeData = Object.values(typeCounts); 
    
    if (typeChartInstance) typeChartInstance.destroy();
    typeChartInstance = new Chart(typeCtx, {
      type: 'bar',
      data: { labels: typeLabels, datasets: [{
          label: 'Jumlah Aset', 
          data: typeData, 
          backgroundColor: '#ff7a18', // Menggunakan Accent (Oranye)
          borderRadius: 4,
      }]},
      options: {
        responsive: true,
        plugins: { legend: { display: false } },
        scales: {
          y: { beginAtZero: true, ticks: { color: '#777777' }, grid: { color: '#E0E0E0' } },
          x: { ticks: { color: '#777777' }, grid: { display: false } }
        }
      }
    });

    // Update Chart Status QC (Doughnut)
    const qcCtx = $('#qcStatusChart').getContext('2d');
    const qcLabels = Object.keys(qcStatusCounts);
    const qcData = Object.values(qcStatusCounts);
    
    // Mapping warna untuk Doughnut Chart
    const chartColors = {
      'Lulus QC': '#1db954', // HIJAU
      'Gagal QC': '#dc3545', // MERAH
      'Belum QC': '#007bff', // BIRU
      'Unknown': '#777777'   // ABU
    };

    const dataColors = qcLabels.map(label => chartColors[label] || chartColors['Unknown']);
    
    if (qcStatusChartInstance) qcStatusChartInstance.destroy();
    qcStatusChartInstance = new Chart(qcCtx, {
      type: 'doughnut',
      data: {
        labels: qcLabels,
        datasets: [{
          backgroundColor: dataColors, // Menggunakan warna Hijau, Merah, Biru semantik
          data: qcData,
          borderColor: '#F8F8F8', borderWidth: 3,
        }]
      },
      options: {
        responsive: true,
        plugins: {
          legend: { position: 'bottom', labels: { color: '#777777', boxWidth: 12, padding: 20 } }
        }
      }
    });
  }

  function handleTableActions(e) {
    const target = e.target.closest('button[data-action]');
    if (!target) return;
    const action = target.dataset.action;
    const id = target.dataset.id;
    const asset = allAssetsCache.find(a => a.id === id);
    if (!asset) return showToast('Error: Aset tidak ditemukan.', true);

    if (action === 'view') openViewModal(asset);
    else if (action === 'edit') openAssetModal(asset);
    else if (action === 'delete') deleteAsset(id);
  }

  function openAssetModal(asset = null) {
    const modal = $('#assetModal');
    $('#assetForm').reset(); 
    
    // Reset tombol save saat modal dibuka
    const saveBtn = $('#saveAssetBtn');
    saveBtn.disabled = false;
    saveBtn.textContent = 'Simpan Aset';
    saveBtn.classList.remove('opacity-50', 'cursor-not-allowed');
    
    if (asset) {
      // --- MODE EDIT ---
      $('#assetModalTitle').textContent = 'Edit Aset';
      $('#assetId').value = asset.id;
      $('#assetName').value = asset.name || '';
      $('#qty').value = asset.qty || 1;
      $('#type').value = asset.type || ''; 
      $('#serialNumber').value = asset.serial || '';
      
      $('#purchasePrice').value = asset.purchasePrice || '';
      $('#vendorId').value = asset.vendorId || '';
      
      $('#qcStatus').value = asset.qcStatus || 'Belum QC';
      $('#location').value = asset.location || '';
      $('#pic').value = asset.pic || '';
      $('#purchaseDate').value = asset.purchaseDate || '';
      $('#warrantyUntil').value = asset.warrantyUntil || '';
      $('#software').value = asset.software || '';
      $('#notes').value = asset.notes || '';
    } else {
      // --- MODE TAMBAH ---
      $('#assetModalTitle').textContent = 'Tambah Aset Baru';
      $('#assetId').value = '';
      $('#qty').value = 1;
      $('#type').value = ''; 
      $('#qcStatus').value = 'Belum QC';
      
      $('#purchasePrice').value = '';
      $('#vendorId').value = '';
    }
    modal.classList.add('active');
  }
  
  async function openViewModal(asset) {
    const modal = $('#viewAssetModal');
    
    // Isi info dasar
    $('#viewModalTitle').textContent = `Detail: ${asset.name}`;
    $('#view-name').textContent = asset.name || '-';
    $('#view-type').textContent = asset.type || '-';
    $('#view-qty').textContent = asset.qty || '0';
    $('#view-serial').textContent = asset.serial || '-';
    $('#view-qcStatus').textContent = asset.qcStatus || '-';
    $('#view-location').textContent = asset.location || '-';
    $('#view-pic').textContent = asset.pic || '-';
    $('#view-purchaseDate').textContent = formatDate(asset.purchaseDate);
    $('#view-warrantyUntil').textContent = formatDate(asset.warrantyUntil);
    $('#view-software').textContent = asset.software || '-';
    $('#view-notes').textContent = asset.notes || '(Tidak ada catatan)';
    
    const formattedPrice = (asset.purchasePrice || 0).toLocaleString('id-ID', {
      style: 'currency',
      currency: 'IDR',
      maximumFractionDigits: 0
    });
    $('#view-purchasePrice').textContent = asset.purchasePrice ? formattedPrice : '-';

    const vendor = allVendorsCache.find(v => v.id === asset.vendorId);
    $('#view-vendor').textContent = vendor ? vendor.name : '-';
    
    modal.classList.add('active');
    
    // Ambil dan tampilkan riwayat
    const historyContainer = $('#view-history');
    historyContainer.innerHTML = `<p class="text-dark-muted text-sm">Memuat riwayat...</p>`;
    
    try {
      const historyQuery = fb_assetsCollectionRef.doc(asset.id).collection('history').orderBy('timestamp', 'desc').limit(10);
      const snapshot = await historyQuery.get();
      
      if (snapshot.empty) {
        historyContainer.innerHTML = `<p class="text-dark-muted text-sm">(Tidak ada riwayat tersimpan)</p>`;
        return;
      }
      
      historyContainer.innerHTML = snapshot.docs.map(doc => {
        const log = doc.data();
        const timestamp = log.timestamp ? log.timestamp.toDate().toLocaleString('id-ID') : 'Baru saja';
        return `
          <div class="text-sm">
            <span class="font-bold text-accent">[${log.type}]</span>
            <span class="text-dark-muted">${timestamp}</span>
            <p class="text-dark-text ml-2">${log.message} (by ${log.adminEmail || 'Admin'})</p>
          </div>
        `;
      }).join('<hr class="border-light-border/50 my-2">');

    } catch (e) {
      console.error("Error fetching asset history: ", e);
      historyContainer.innerHTML = `<p class="text-error text-sm">Gagal memuat riwayat.</p>`;
    }
  }
  
  function exportToExcel() {
    const searchTerm = $('#searchInput').value.toLowerCase();
    const qcStatusFilter = $('#filterQcStatus').value;
    const typeFilter = $('#filterType').value;

    const filteredAssets = allAssetsCache.filter(asset => {
      const searchMatch = !searchTerm ||
        (asset.name && asset.name.toLowerCase().includes(searchTerm)) ||
        (asset.serial && asset.serial.toLowerCase().includes(searchTerm)) ||
        (asset.pic && asset.pic.toLowerCase().includes(searchTerm)) ||
        (asset.location && asset.location.toLowerCase().includes(searchTerm)) ||
        (asset.id && asset.id.toLowerCase().includes(searchTerm)); 
      const qcStatusMatch = !qcStatusFilter || asset.qcStatus === qcStatusFilter;
      const typeMatch = !typeFilter || asset.type === typeFilter;
      return searchMatch && qcStatusMatch && typeMatch;
    });

    if (filteredAssets.length === 0) return showToast('Tidak ada data aset untuk diexport', true);

    const dataToExport = filteredAssets.map(a => {
      const vendor = allVendorsCache.find(v => v.id === a.vendorId);
      
      return {
        'ID Aset': a.id,
        'Nama Aset': a.name,
        'Tipe': a.type,
        'Qty': a.qty,
        'Status QC': a.qcStatus,
        'Harga Beli': a.purchasePrice || 0, 
        'Vendor': vendor ? vendor.name : '', 
        'Serial Number': a.serial,
        'Lokasi': a.location,
        'PIC': a.pic,
        'Software': a.software,
        'Tgl Beli': a.purchaseDate,
        'Garansi Sampai': a.warrantyUntil,
        'Catatan': a.notes,
        'Update Terakhir': a.lastUpdate ? a.lastUpdate.toDate().toLocaleString('id-ID') : '',
      };
    });
    
    try {
      const ws = XLSX.utils.json_to_sheet(dataToExport);
      const wb = XLSX.utils.book_new();
      XLSX.utils.book_append_sheet(wb, ws, 'Aset IT');
      XLSX.writeFile(wb, `Export_Aset_IT_${new Date().toISOString().slice(0,10)}.xlsx`);
      showToast('Data berhasil diexport ke Excel');
    } catch(e) {
      console.error("Gagal export Excel: ", e);
      showToast('Gagal export Excel', true);
    }
  }

</script>

</body>
</html>
